<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturación</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome para iconos -->
    <link rel="shortcut icon" href="https://i.ibb.co/r21Tj1nF/icon-halltec.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* General Reset and Base Styles */
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: #f0f4f8;
        color: #2d3748;
    }

    .container-fluid {
        padding: 0;
    }

    /* Sidebar */
    .sidebar {
        min-height: 100vh;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        border-right: 1px solid #2c5282;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        padding-top: 20px;
        position: fixed;
        width: 250px;
        transition: width 0.3s ease;
        z-index: 100;
    }

    .sidebar h4 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 2rem;
        text-align: center;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #e2e8f0;
        font-weight: 500;
        border-radius: 8px;
        margin: 4px 10px;
        transition: all 0.2s ease;
    }

    .nav-link i {
        margin-right: 10px;
        font-size: 1.2rem;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    .nav-link.active {
        background-color: #ffffff;
        color: #1e3a8a;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Logout Button */
    .sidebar .btn-danger {
        margin: 20px 10px;
        padding: 12px;
        font-weight: 500;
        border-radius: 8px;
        background-color: #e53e3e;
        border-color: #e53e3e;
        transition: background-color 0.2s ease;
    }

    .sidebar .btn-danger:hover {
        background-color: #c53030;
        border-color: #c53030;
    }

    /* Content Area */
    .content {
        margin-left: 250px;
        padding: 30px;
        background-color: #f0f4f8;
        min-height: 100vh;
    }

    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2d3748;
    }

    .card-text.h3 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
    }

    /* Ajustes para tablas */
    .table {
        width: 100%;
        font-size: 0.95rem; /* Tamaño de fuente legible */
        border-collapse: separate;
        border-spacing: 0;
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        overflow: hidden;
    }

    .table thead {
        background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 100%);
        color: white;
    }

    .table th, .table td {
        padding: 12px 15px; /* Más espacio interno */
        vertical-align: middle;
        text-align: left;
        white-space: nowrap; /* Evita que el texto se rompa innecesariamente */
        overflow: hidden;
        max-width: 300px; /* Limita el ancho de las celdas */
    }

    .table th {
        background-color: #1e3a8a;
        color: white;
        font-weight: 600;
    }
    /* Contenedor responsive */
    .table-responsive {
        overflow-x: auto; /* Permite desplazamiento horizontal en pantallas pequeñas */
        margin-bottom: 20px;
    }

    /* Botones de acción en tablas */
    .table .btn {
        padding: 6px 10px;
        font-size: 0.9rem;
        margin-right: 5px;
    }
    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f9fafb;
    }

    .table-hover tbody tr:hover {
        background-color: #eff6ff;
    }

    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        border-color: #2563eb;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .btn-primary:hover, .btn-primary:focus {
        background: linear-gradient(135deg, #1e4620 0%, #2563eb 100%);
        border-color: #1e40af;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(37, 99, 235, 0.25);
    }

    .btn-success {
        background: linear-gradient(135deg, #047857 0%, #10b981 100%);
        border-color: #059669;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    .btn-success:hover, .btn-success:focus {
        background: linear-gradient(135deg, #065f46 0%, #059669 100%);
        border-color: #047857;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
    }

    .btn-danger {
        background: linear-gradient(135deg, #b91c1c 0%, #ef4444 100%);
        border-color: #dc2626;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    .btn-danger:hover, .btn-danger:focus {
        background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
        border-color: #b91c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
    }

    .btn-info {
        background: linear-gradient(135deg, #0284c7 0%, #38bdf8 100%);
        border-color: #0ea5e9;
        color: white !important;
        box-shadow: 0 2px 4px rgba(56, 189, 248, 0.2);
    }

    .btn-info:hover, .btn-info:focus {
        background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
        border-color: #0284c7;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(56, 189, 248, 0.25);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #475569 0%, #64748b 100%);
        border-color: #64748b;
        box-shadow: 0 2px 4px rgba(100, 116, 139, 0.2);
    }

    .btn-secondary:hover, .btn-secondary:focus {
        background: linear-gradient(135deg, #334155 0%, #475569 100%);
        border-color: #475569;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(100, 116, 139, 0.25);
    }

    .btn i {
        margin-right: 6px;
    }

    /* Modals */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }

    .modal-header {
        border-bottom: 1px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    .modal-header.bg-primary, .modal-header.bg-success, .modal-header.bg-info, .modal-header.bg-danger {
        background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 100%) !important;
    }

    .modal-header.bg-success {
        background: linear-gradient(90deg, #047857 0%, #10b981 100%) !important;
    }

    .modal-header.bg-info {
        background: linear-gradient(90deg, #0284c7 0%, #38bdf8 100%) !important;
    }

    .modal-header.bg-danger {
        background: linear-gradient(90deg, #b91c1c 0%, #ef4444 100%) !important;
    }

    .modal-title {
        font-weight: 600;
        color: white;
        display: flex;
        align-items: center;
    }

    .modal-title i {
        margin-right: 8px;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 1px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 10px 12px;
        font-size: 0.95rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    /* Dashboard Cards */
    .card.bg-primary {
        background: linear-gradient(45deg, #1e40af, #3b82f6) !important;
        border: none;
    }

    .card.bg-success {
        background: linear-gradient(45deg, #047857, #10b981) !important;
        border: none;
    }

    .card.bg-info {
        background: linear-gradient(45deg, #0284c7, #38bdf8) !important;
        border: none;
    }

    /* Input Groups */
    .input-group-text {
        background-color: #f1f5f9;
        border-color: #d1d5db;
        color: #64748b;
    }



    .search-box .form-control {
        padding-left: 40px;
        background-color: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .search-box .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        z-index: 10;
    }


    .page-item:first-child .page-link {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .page-item:last-child .page-link {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }



    .page-item.active .page-link {
        background-color: #1e40af;
        border-color: #1e40af;
    }

    .page-item.disabled .page-link {
        color: #94a3b8;
        background-color: #f8fafc;
        border-color: #e2e8f0;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .sidebar {
            width: 80px;
        }

        .sidebar h4, .sidebar .nav-link span, .sidebar .btn-danger span {
            display: none;
        }

        .sidebar .nav-link {
            padding: 12px;
            justify-content: center;
        }

        .sidebar .nav-link i {
            margin-right: 0;
            font-size: 1.25rem;
        }

        .sidebar .btn-danger {
            padding: 12px;
            display: flex;
            justify-content: center;
        }

        .content {
            margin-left: 80px;
        }
    }

    @media (max-width: 768px) {
        .content {
            margin-left: 0;
            padding: 16px;
        }

        .sidebar {
            width: 100%;
            height: auto;
            position: relative;
            min-height: 0;
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        .sidebar .nav {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .sidebar h4 {
            margin-bottom: 0;
            margin-right: 15px;
            display: block;
        }

        .sidebar .nav-link {
            padding: 8px 12px;
            margin: 2px 5px;
        }

        .sidebar .btn-danger {
            margin: 2px 5px;
            padding: 8px 12px;
        }

        .card {
            margin-bottom: 16px;
        }
    }



    @keyframes rotation {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }


    .empty-state i {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 1.5rem;
    }

    .empty-state h4 {
        color: #475569;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #64748b;
        max-width: 500px;
        margin: 0 auto 1.5rem;
    }
</style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <div class="d-flex flex-column p-3">
                <div class="text-center mb-4">
                    <img src="https://i.ibb.co/r21Tj1nF/icon-halltec.png" alt="Logo" width="40" class="mb-2">
                    <h4>FACTUS</h4>
                </div>
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link active" id="dashboard-link">
                            <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link" id="productos-link">
                            <i class="fas fa-box"></i> <span>Productos</span>
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link" id="clientes-link">
                            <i class="fas fa-users"></i> <span>Clientes</span>
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link" id="facturas-link">
                            <i class="fas fa-file-invoice-dollar"></i> <span>Facturas</span>
                        </a>
                    </li>
                </ul>
                <form id="logoutForm" class="px-4" th:action="@{/logout}" method="post">
                    <button type="button" class="btn btn-danger btn-block" onclick="confirmLogout()">
                        <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
                    </button>
                </form>
            </div>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-10 content">
            <!-- Dashboard -->
            <div id="dashboard-content" class="content-section">
                <h2 class="mb-4">Dashboard</h2>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card bg-primary text-white">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-users fa-2x me-3"></i>
                                <div>
                                    <h5 class="card-title">Clientes</h5>
                                    <p class="card-text h3" id="total-clientes">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card bg-success text-white">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-box fa-2x me-3"></i>
                                <div>
                                    <h5 class="card-title">Productos</h5>
                                    <p class="card-text h3" id="total-productos">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card bg-info text-white">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-file-invoice-dollar fa-2x me-3"></i>
                                <div>
                                    <h5 class="card-title">Facturas</h5>
                                    <p class="card-text h3" id="total-facturas">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="productos-content" class="content-section" style="display:none;">
                <div class="d-flex justify-content-between align-items-center mb-6">
                    <h2>Gestión de Productos</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productoModal">
                        <i class="fas fa-plus"></i> Nuevo Producto
                    </button>
                </div>
                <div class="mb-3 search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control" id="buscar-productos" placeholder="Buscar producto por nombre o ID...">
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Precio</th>
                            <th scope="col">Unidad Medida</th>
                            <th scope="col">Tasa IVA</th>
                            <th scope="col">Código Estándar</th>
                            <th scope="col">Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="productos-table-body"></tbody>
                    </table>
                    <nav aria-label="Product pagination">
                        <ul class="pagination justify-content-center" id="productos-pagination"></ul>
                    </nav>
                </div>
            </div>

            <!-- Sección Clientes -->
            <div id="clientes-content" class="content-section" style="display:none;">
                <div class="d-flex justify-content-between mb-6">
                    <h2>Gestión de Clientes</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clienteModal">
                        <i class="fas fa-plus"></i> Nuevo Cliente
                    </button>
                </div>
                <!-- Campo de búsqueda -->
                <div class="mb-3 search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control" id="buscar-clientes" placeholder="Buscar cliente por nombre o identificación...">
                </div>
                <div class="table-responsive">

                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo de cliente</th>
                            <th>Identificación</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Id legal</th>
                            <th>Id tributo</th>
                            <th>Iva</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="clientes-table-body">
                        <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                    <nav aria-label="Client pagination">
                        <ul class="pagination justify-content-center" id="clientes-pagination"></ul>
                    </nav>
                </div>
            </div>

            <!-- Sección Facturas -->
            <div id="facturas-content" class="content-section" style="display:none;">
                <div class="d-flex justify-content-between mb-6">
                    <h2>Gestión de Facturas</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#facturaModal">
                        <i class="fas fa-plus"></i> Nueva Factura
                    </button>
                </div>

                <!-- Campo de búsqueda -->
                <div class="mb-3 search-box">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control" id="buscar-facturas" placeholder="Buscar factura por número o cliente...">
                </div>

                <div class="table-responsive">

                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>Número</th>
                            <th>Cliente</th>
                            <th>ID</th>
                            <th>Pago</th>
                            <th>Metodo</th>
                            <th>Creación factura</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Acciones</th>


                        </tr>
                        </thead>
                        <tbody id="facturas-table-body">
                        <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                    <nav aria-label="Invoice pagination">
                        <ul class="pagination justify-content-center" id="facturas-pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Producto actualizado con los nuevos campos -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productoModalLabel"><i class="fas fa-box"></i> Nuevo Producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="producto-form">
                    <input type="hidden" id="producto-id">
                    <input type="hidden" id="producto-standardCodeId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="producto-nombre" class="form-label">Nombre</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    <input type="text" class="form-control" id="producto-nombre" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="producto-precio" class="form-label">Precio</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                    <input type="number" step="0.01" class="form-control" id="producto-precio" required>
                                </div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="producto-excluido">
                                <label class="form-check-label" for="producto-excluido">Excluido de impuestos</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="producto-medida" class="form-label">Unidad de Medida</label>
                                <select class="form-select" id="producto-medida" required>
                                    <option value="70">Unidad</option>
                                    <option value="414">Kilogramo</option>
                                    <option value="449">Litro</option>
                                    <option value="512">Metro</option>
                                    <option value="874">Galon</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="producto-tasa-iva" class="form-label">Tasa IVA (%)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-percent"></i></span>
                                    <input type="number" step="0.01" class="form-control" id="producto-tasa-iva" value="19">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="producto-retencion" class="form-label">Tasa Retención</label>
                                <input type="text" class="form-control" id="producto-retencion">
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Los campos de Código Estándar y Unidad de Medida se generarán automáticamente.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="guardar-producto">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente Actualizado -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="clienteModalLabel"><i class="fas fa-user"></i> Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cliente-form">
                    <input type="hidden" id="cliente-id">
                    <input type="hidden" id="cliente-legalOrganizationId">
                    <input type="hidden" id="cliente-tributeId">

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente-tipo" class="form-label"><i class="fas fa-id-badge"></i> Tipo Cliente</label>
                                <select class="form-select" id="cliente-tipo" required>
                                    <option value="Persona Natural">Persona Natural</option>
                                    <option value="Persona Jurídica">Persona Jurídica</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="cliente-tipo-identificacion" class="form-label"><i class="fas fa-id-card"></i> Tipo Identificación</label>
                                <select class="form-select" id="cliente-tipo-identificacion" required>
                                    <option value="Cédula">Cédula de Ciudadanía</option>
                                    <option value="NIT">NIT</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label for="cliente-identificacion" class="form-label"><i class="fas fa-fingerprint"></i> Identificación</label>
                                <input type="text" class="form-control" id="cliente-identificacion" required>
                            </div>

                            <div class="mb-3">
                                <label for="cliente-nombre" class="form-label"><i class="fas fa-user-tag"></i> Nombre</label>
                                <input type="text" class="form-control" id="cliente-nombre" required>
                            </div>
                            <div class="mb-3">
                                <label for="cliente-telefono" class="form-label"><i class="fas fa-phone"></i> Teléfono</label>
                                <input type="text" class="form-control" id="cliente-telefono">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente-correo" class="form-label"><i class="fas fa-envelope"></i> Correo</label>
                                <input type="email" class="form-control" id="cliente-correo">
                            </div>

                            <div class="mb-3">
                                <label for="cliente-municipio" class="form-label"><i class="fas fa-city"></i> Municipio</label>
                                <input type="text" class="form-control" id="cliente-municipio">
                            </div>

                            <div class="mb-3">
                                <label for="cliente-direccion" class="form-label"><i class="fas fa-map-marker-alt"></i> Dirección</label>
                                <input type="text" class="form-control" id="cliente-direccion">
                            </div>

                            <div class="mb-3">
                                <label for="cliente-aplica-iva" class="form-label"><i class="fas fa-receipt"></i> Aplica IVA</label>
                                <select class="form-select" id="cliente-aplica-iva" required>
                                    <option value="Sí">Sí</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Campos específicos para Persona Jurídica -->
                    <div id="campos-juridica" class="row mt-3" style="display: none;">
                        <div class="col-12">
                            <h6 class="mb-3 border-bottom pb-2"><i class="fas fa-building"></i> Información Comercial</h6>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente-company" class="form-label"><i class="fas fa-building"></i> Razón Social</label>
                                <input type="text" class="form-control" id="cliente-company">
                            </div>
                            <div class="mb-3">
                                <label for="cliente-tradeName" class="form-label"><i class="fas fa-store"></i> Nombre Comercial</label>
                                <input type="text" class="form-control" id="cliente-tradeName">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="cliente-verificationDigit" class="form-label"><i class="fas fa-check-circle"></i> Dígito de Verificación</label>
                                <input type="text" class="form-control" id="cliente-verificationDigit" maxlength="1">
                            </div>
                            <div class="mb-3">
                                <label for="cliente-idOrg" class="form-label"><i class="fas fa-id-badge"></i> ID Organización</label>
                                <input type="text" class="form-control" id="cliente-idOrg">
                            </div>
                        </div>
                    </div>

                    <!-- Información sobre campos automáticos -->
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <small><i class="fas fa-info-circle"></i> Los campos de ID Organización Legal y ID Tributo se generarán automáticamente según el tipo de cliente.</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
                <button type="button" class="btn btn-success" id="guardar-cliente"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Actualización del Modal Factura con campos automáticos adicionales -->
<div class="modal fade" id="facturaModal" tabindex="-1" aria-labelledby="facturaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="facturaModalLabel"><i class="fas fa-file-invoice-dollar"></i> Nueva Factura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="factura-form">
                    <input type="hidden" id="factura-id">
                    <!-- Campos automáticos ocultos -->
                    <input type="hidden" id="factura-document" value="Factura electrónica de venta">
                    <input type="hidden" id="factura-numbering-range-id">
                    <input type="hidden" id="factura-reference-code">

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="factura-cliente" class="form-label"><i class="fas fa-user-circle"></i> Cliente</label>
                                <select class="form-select" id="factura-cliente" required>
                                    <!-- Se llenará con JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="factura-forma-pago" class="form-label"><i class="fas fa-money-check"></i> Forma de Pago</label>
                                <select class="form-select" id="factura-forma-pago" required>
                                    <option value="Contado">Contado</option>
                                    <option value="Crédito">Crédito</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="factura-metodo-pago" class="form-label"><i class="fas fa-credit-card"></i> Método de Pago</label>
                                <select class="form-select" id="factura-metodo-pago" required>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Cheque">Cheque</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="Tarjeta Crédito">Tarjeta Crédito</option>
                                    <option value="Tarjeta Débito">Tarjeta Débito</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="factura-fecha" class="form-label"><i class="fas fa-calendar-alt"></i> Fecha</label>
                                <input type="date" class="form-control" id="factura-fecha" required>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="factura-identification" class="form-label"><i class="fas fa-id-card"></i> Identificación</label>
                                <input type="text" class="form-control" id="factura-identification" readonly>
                            </div>
                            <div class="mb-3">
                                <label for="factura-api-client-name" class="form-label"><i class="fas fa-user-tag"></i> Nombre API Cliente</label>
                                <input type="text" class="form-control" id="factura-api-client-name" readonly>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="factura-document-name" class="form-label"><i class="fas fa-file-alt"></i> Nombre Documento</label>
                                <input type="text" class="form-control" id="factura-document-name" value="Factus" >
                            </div>
                            <div class="mb-3">
                                <label for="factura-graphic-representation" class="form-label"><i class="fas fa-file-image"></i> Representación Gráfica</label>
                                <input type="text" class="form-control" id="factura-graphic-representation" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Información adicional del cliente -->
                    <div class="row mt-2 mb-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-address-card"></i> Información del Cliente</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p><strong>Nombre:</strong> <span id="cliente-nombres">-</span></p>
                                            <p><strong>Tipo Cliente:</strong> <span id="cliente-tipos">-</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Correo:</strong> <span id="cliente-correos">-</span></p>
                                            <p><strong>Teléfono:</strong> <span id="cliente-telefonos">-</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Dirección:</strong> <span id="cliente-direcciones">-</span></p>
                                            <p><strong>Municipio:</strong> <span id="cliente-municipios">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campos automáticos visibles -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0"><i class="fas fa-cogs"></i> Información Automática</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <p><strong>Estado:</strong> <span id="factura-status">PENDIENTE</span></p>
                                            <p><strong>Número:</strong> <span id="factura-numero">-</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p><strong>Documento:</strong> <span id="factura-document-display">Factura electrónica de venta</span></p>
                                            <p><strong>Código de Referencia:</strong> <span id="factura-reference-code-display">-</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="mb-3">
                                                <label for="factura-observation" class="form-label"><i class="fas fa-comment" ></i> Observación</label>
                                                <textarea class="form-control" id="factura-observation" rows="2" placeholder="Cliente capacitado"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h4><i class="fas fa-shopping-cart"></i> Productos</h4>
                    <div class="mb-3">
                        <button type="button" class="btn btn-success" id="agregar-item">
                            <i class="fas fa-plus"></i> Agregar Producto
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-box"></i> Producto</th>
                                <th><i class="fas fa-hashtag"></i> Cantidad</th>
                                <th><i class="fas fa-dollar-sign"></i> Precio</th>
                                <th><i class="fas fa-percentage"></i> Descuento %</th>
                                <th><i class="fas fa-calculator"></i> Subtotal</th>
                                <th><i class="fas fa-receipt"></i> IVA</th>
                                <th><i class="fas fa-money-bill-wave"></i> Total</th>
                                <th><i class="fas fa-cogs"></i> Acciones</th>
                            </tr>
                            </thead>
                            <tbody id="factura-items">
                            <!-- Se llenará con JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <div class="row justify-content-end">
                        <div class="col-md-4">
                            <div class="card shadow">
                                <div class="card-header bg-dark text-white">
                                    <h5 class="mb-0"><i class="fas fa-file-invoice"></i> Resumen</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6><i class="fas fa-calculator"></i> Subtotal:</h6>
                                        <span id="factura-subtotal">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6><i class="fas fa-receipt"></i> IVA:</h6>
                                        <span id="factura-iva-total">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2">
                                        <h6><i class="fas fa-percent"></i> Descuento:</h6>
                                        <span id="factura-descuento-total">$0.00</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <h5><i class="fas fa-money-bill-wave"></i> TOTAL:</h5>
                                        <h5 id="factura-total">$0.00</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <!-- Modal para seleccionar productos -->
            <div class="modal fade" id="seleccionarProductoModal" tabindex="-1" aria-labelledby="seleccionarProductoModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-primary text-white">
                            <h5 class="modal-title" id="seleccionarProductoModalLabel">Seleccionar Producto</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="buscar-producto" placeholder="Buscar producto...">
                            </div>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Nombre</th>
                                        <th>Precio</th>
                                        <th>Unidad Medida</th>
                                        <th>Tasa IVA</th>
                                        <th>Acciones</th>
                                    </tr>
                                    </thead>
                                    <tbody id="seleccionar-producto-body">
                                    <!-- Se llenará con JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
                <button type="button" class="btn btn-info text-white" id="guardar-factura"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este elemento? Esta acción no se puede deshacer.</p>
                <input type="hidden" id="delete-type">
                <input type="hidden" id="delete-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmar-eliminacion">Eliminar</button>
            </div>
        </div>
    </div>
</div>
<!-- Scripts de Bootstrap y jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

<!-- Script principal -->

<script>

    $(document).ready(function() {
// Buscador para Productos
        $('#buscar-productos').on('keyup', function() {
            loadProductos(1);
            const searchTerm = $(this).val().toLowerCase();
            $('#productos-table-body tr').each(function() {
                const id = $(this).find('td:eq(0)').text().toLowerCase();
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                if (id.includes(searchTerm) || nombre.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

// Buscador para Clientes
        $('#buscar-clientes').on('keyup', function() {
            loadClientes(1);
            const searchTerm = $(this).val().toLowerCase();
            $('#clientes-table-body tr').each(function() {
                const id = $(this).find('td:eq(0)').text().toLowerCase();
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                const identificacion = $(this).find('td:eq(3)').text().toLowerCase();
                if (id.includes(searchTerm) || nombre.includes(searchTerm) || identificacion.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

// Buscador para Facturas
        $('#buscar-facturas').on('keyup', function() {
            loadFacturas(1);
            const searchTerm = $(this).val().toLowerCase();
            $('#facturas-table-body tr').each(function() {
                const numero = $(this).find('td:eq(0)').text().toLowerCase();
                const cliente = $(this).find('td:eq(1)').text().toLowerCase();
                if (numero.includes(searchTerm) || cliente.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $('#dashboard-link, #productos-link, #clientes-link, #facturas-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();

            $('#buscar-productos, #buscar-clientes, #buscar-facturas').val('');

            if ($(this).is('#dashboard-link')) {
                $('#dashboard-content').show();
                loadDashboardStats();
            } else if ($(this).is('#productos-link')) {
                $('#productos-content').show();
                loadProductos(1); // Siempre inicia en página 1
            } else if ($(this).is('#clientes-link')) {
                $('#clientes-content').show();
                loadClientes(1); // Siempre inicia en página 1
            } else if ($(this).is('#facturas-link')) {
                $('#facturas-content').show();
                loadFacturas(1); // Siempre inicia en página 1
            }
        });

        let clientesList = []; // Lista de clientes para acceso global
        // Navegación
        $('#dashboard-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#dashboard-content').show();
            loadDashboardStats();
        });

        $('#productos-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#productos-content').show();
            loadProductos();
        });

        $('#clientes-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#clientes-content').show();
            loadClientes();
        });

        $('#facturas-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#facturas-content').show();
            loadFacturas();
        });

        // Confirmar logout
        window.confirmLogout = function() {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Quieres cerrar sesión?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, cerrar sesión',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById("logoutForm").submit();
                }
            });
        };

        // Funciones de carga de datos
        function loadDashboardStats() {
            $.ajax({
                url: '/api/clientes',
                method: 'GET',
                success: function(data) {
                    $('#total-clientes').text(data.length);
                }
            });


            $.ajax({
                url: '/api/productos',
                method: 'GET',
                success: function(data) {
                    $('#total-productos').text(data.length);
                }
            });

            $.ajax({
                url: '/api/facturas/listar',
                method: 'GET',
                success: function(data) {
                    $('#total-facturas').text(data.length);
                }
            });
        }

        function renderPagination(totalPages, currentPage, section) {
            console.log(`Renderizando paginación para ${section}: Total páginas = ${totalPages}, Página actual = ${currentPage}`);
            const paginationUl = $(`#${section}-pagination`);
            paginationUl.empty();

            if (totalPages <= 1) {
                console.log('No se necesita paginación (1 página o menos)');
                return;
            }

            const maxPagesToShow = 3;
            let startPage = Math.max(1, currentPage - 1);
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // Previous button
            paginationUl.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);

            // First page
            if (startPage > 1) {
                paginationUl.append(`
            <li class="page-item ${currentPage === 1 ? 'active' : ''}">
                <a class="page-link" href="#" data-page="1">1</a>
            </li>
        `);
                if (startPage > 2) {
                    paginationUl.append(`
                <li class="page-item disabled">
                    <a class="page-link" href="#">...</a>
                </li>
            `);
                }
            }

            // Pages
            for (let i = startPage; i <= endPage; i++) {
                paginationUl.append(`
            <li class="page-item ${currentPage === i ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
            }

            // Last page and ellipsis
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationUl.append(`
                <li class="page-item disabled">
                    <a class="page-link" href="#">...</a>
                </li>
            `);
                }
                paginationUl.append(`
            <li class="page-item ${currentPage === totalPages ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>
            </li>
        `);
            }

            // Next button
            paginationUl.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);

            // Add click event based on section
            $(`#${section}-pagination .page-link`).click(function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && !$(this).parent().hasClass('disabled') && !$(this).parent().hasClass('active')) {
                    if (section === 'productos') {
                        loadProductos(page);
                    } else if (section === 'clientes') {
                        loadClientes(page);
                    } else if (section === 'facturas') {
                        loadFacturas(page);
                    }
                }
            });
        }

        function loadClientes(page = 1, itemsPerPage = 6) {
            $.ajax({
                url: '/api/clientes',
                method: 'GET',
                success: function(data) {
                    const tbody = $('#clientes-table-body');
                    tbody.empty();

                    const searchTerm = $('#buscar-clientes').val().toLowerCase();
                    const filteredData = data.filter(cliente =>
                        cliente.id.toString().includes(searchTerm) ||
                        cliente.nombre.toLowerCase().includes(searchTerm) ||
                        cliente.identificacion.toLowerCase().includes(searchTerm)
                    );

                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const currentPage = Math.min(Math.max(1, page), totalPages);
                    const paginatedData = filteredData.slice(startIndex, endIndex);

                    paginatedData.forEach(function(cliente) {
                        tbody.append(`
                    <tr>
                        <td>${cliente.id}</td>
                        <td>${cliente.nombre}</td>
                        <td>${cliente.tipoCliente}</td>
                        <td>${cliente.identificacion}</td>
                        <td>${cliente.telefono || 'N/A'}</td>
                        <td>${cliente.correo || 'N/A'}</td>
                        <td>${cliente.legalOrganizationId || 'N/A'}</td>
                        <td>${cliente.tributeId || 'N/A'}</td>
                        <td>${cliente.aplicaIVA || 'No'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-cliente" data-id="${cliente.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-cliente" data-id="${cliente.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
                    });

                    if (paginatedData.length === 0) {
                        tbody.append(`
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h4>No hay clientes</h4>
                                <p>No se encontraron clientes que coincidan con la búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `);
                    }

                    renderPagination(totalPages, currentPage, 'clientes');

                    $('.edit-cliente').click(function() {
                        const id = $(this).data('id');
                        editCliente(id);
                    });

                    $('.delete-cliente').click(function() {
                        const id = $(this).data('id');
                        openDeleteModal('cliente', id);
                    });
                }
            });
        }

        $('#buscar-clientes').on('keyup', function() {
            loadClientes(1);
        });
        function loadFacturas(page = 1, itemsPerPage = 6) {
            $.ajax({
                url: '/api/facturas/listar',
                method: 'GET',
                success: function(data) {
                    const tbody = $('#facturas-table-body');
                    tbody.empty();

                    const searchTerm = $('#buscar-facturas').val().toLowerCase();
                    const filteredData = data.filter(factura =>
                        factura.numero?.toLowerCase().includes(searchTerm) ||
                        factura.cliente?.nombre.toLowerCase().includes(searchTerm)
                    );

                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const currentPage = Math.min(Math.max(1, page), totalPages);
                    const paginatedData = filteredData.slice(startIndex, endIndex);

                    paginatedData.forEach(function(factura) {
                        const clienteNombre = factura.cliente ? factura.cliente.nombre : 'N/A';
                        const fecha = factura.createdAt ? new Date(factura.createdAt).toLocaleDateString() : 'N/A';
                        tbody.append(`
                    <tr>
                        <td>${factura.numero || 'N/A'}</td>
                        <td>${clienteNombre}</td>
                        <td>${factura.identificacion || 'N/A'}</td>
                        <td>${factura.pagos || 'N/A'}</td>
                        <td>${factura.metodopago || 'N/A'}</td>
                        <td>${factura.createdAt || 'N/A'}</td>
                        <td>${factura.status || 'N/A'}</td>
                        <td>${fecha}</td>
                        <td>$${factura.total?.toFixed(2) || '0.00'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-factura" data-id="${factura.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-info view-factura" data-id="${factura.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary download-factura" data-id="${factura.numero}">
                                <i class="fas fa-download"></i>
                            </button>
                            <button class="btn btn-success btn-sm validate-factura-btn" data-id="${factura.numero}">
                                <i class="bi bi-check-circle"></i>
                            </button>
                            <button class="btn btn-primary btn-sm download-xml-btn" data-id="${factura.numero}">
                                <i class="bi bi-file-earmark-code"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-factura-btn" data-id="${factura.referenceCode || 'N/A'}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
                    });

                    if (paginatedData.length === 0) {
                        tbody.append(`
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h4>No hay facturas</h4>
                                <p>No se encontraron facturas que coincidan con la búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `);
                    }

                    renderPagination(totalPages, currentPage, 'facturas');

                    $('.edit-factura').click(function() {
                        const number = $(this).data('id');
                        editFactura(number);
                    });

                    $('.view-factura').click(function() {
                        const number = $(this).data('id');
                        viewFactura(number);
                    });

                    $('.download-factura').click(function() {
                        const number = $(this).data('id');
                        descargarFactura(number);
                    });

                    $('.validate-factura-btn').click(function() {
                        const number = $(this).data('id');
                        validateFactura(number);
                    });

                    $('.download-xml-btn').click(function() {
                        const number = $(this).data('id');
                        descargarXml(number);
                    });

                    $('.delete-factura-btn').click(function() {
                        const referenceCode = $(this).data('id');
                        eliminarFactura(referenceCode);
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error cargando facturas:", error);
                    $('#facturas-table-body').html('<tr><td colspan="10" class="text-center text-danger">Error al cargar facturas</td></tr>');
                }
            });
        }

        $('#buscar-facturas').on('keyup', function() {
            loadFacturas(1);
        });

        $('#dashboard-link, #productos-link, #clientes-link, #facturas-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();

            $('#buscar-productos, #buscar-clientes, #buscar-facturas').val('');

            if ($(this).is('#dashboard-link')) {
                $('#dashboard-content').show();
                loadDashboardStats();
            } else if ($(this).is('#productos-link')) {
                $('#productos-content').show();
                loadProductos(1); // Siempre inicia en página 1
            } else if ($(this).is('#clientes-link')) {
                $('#clientes-content').show();
                loadClientes(1); // Siempre inicia en página 1
            } else if ($(this).is('#facturas-link')) {
                $('#facturas-content').show();
                loadFacturas(1); // Siempre inicia en página 1
            }
        });


        function viewFactura(id) {
            console.log("Visualizando factura ID:", id);

            // Mostrar un indicador de carga
            Swal.fire({
                title: 'Cargando detalles',
                text: 'Espere por favor...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: `/api/facturas/ver/${id}`,
                method: 'GET',
                success: function(data) {
                    console.log("Detalles de factura recibidos:", data);
                    Swal.close();

                    // Verificar si hay un error en la respuesta
                    if (data.error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.error,
                            confirmButtonColor: '#3085d6'
                        });
                        return;
                    }

                    // Crear el contenido HTML para la factura
                    let customerInfo = '';
                    if (data.cliente) { // Asegúrate de que estás accediendo a "cliente"
                        customerInfo = `
                        <div class="mb-3">
                            <strong>Cliente:</strong> ${data.cliente.nombre || 'N/A'}<br>
                            <strong>Identificación:</strong> ${data.cliente.identificacion || 'N/A'}<br>
                            <strong>Correo:</strong> ${data.cliente.correo || 'N/A'}<br>
                            <strong>Dirección:</strong> ${data.cliente.direccion || 'N/A'}
                        </div>
                    `;
                    }

                    let itemsHTML = '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>Producto</th><th>Cantidad' +
                        '</th><th>Precio</th><th>Iva</th><th>Dto %</th><th>Subtotal</th><th>Total</th></tr></thead><tbody>';

                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            itemsHTML += `
                        <tr>
                            <td>${item.producto || 'N/A'}</td>
                            <td>${item.cantidad || '0'}</td>
                            <td>$${item.precio ? item.precio.toFixed(0) : '0.00'}</td>
                             <td>$${item.iva ? item.iva.toFixed(0) : '0.00'}</td>
                             <td>${item.porcentajeDescuento ? item.porcentajeDescuento.toFixed(1) : '0.00'}</td>
                            <td>$${item.subtotal ? item.subtotal.toFixed(0) : '0.00'}</td>
                            <td>$${item.total ? item.total.toFixed(0) : '0.00'}</td>
                        </tr>
                    `;
                        });
                    } else {
                        itemsHTML += '<tr><td colspan="4" class="text-center">No hay items disponibles</td></tr>';
                    }

                    itemsHTML += '</tbody></table></div>';

                    let totalsHTML = '';
                    if (data.totals) {
                        totalsHTML = `
                    <div class="card mt-3">
                        <div class="card-header bg-info text-white"><strong>Totales</strong></div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Subtotal:</strong> $${data.totals.grossTotal ? data.totals.grossTotal.toFixed(2) : '0.00'}</p>
                                    <p><strong>Descuentos:</strong> $${data.totals.discounts ? data.totals.discounts.toFixed(2) : '0.00'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Impuestos:</strong> $${data.totals.taxes ? data.totals.taxes.toFixed(2) : '0.00'}</p>
                                    <p><strong>Total:</strong> $${data.totals.total ? data.totals.total.toFixed(2) : '0.00'}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                    }

// Mostrar el modal con los detalles
                    Swal.fire({
                        title: `Factura #${data.referenceCode || id}`,
                        html: `
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <strong>Información General</strong>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Estado:</strong> ${data.status || 'N/A'}<br>
                                <strong>Fecha:</strong> ${data.createdAt ? new Date(data.createdAt).toLocaleString() : 'N/A'}<br>
                            </div>
                            ${customerInfo}
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header bg-primary text-white"><strong>Items</strong></div>
                        <div class="card-body">
                            ${itemsHTML}
                        </div>
                    </div>

                    ${totalsHTML}
                </div>
            </div>
        </div>
    `,
                        width: '800px',
                        showCloseButton: true,
                        showConfirmButton: true,
                        confirmButtonText: 'Cerrar',
                        confirmButtonColor: '#3085d6',
                        footer: `<button id="download-btn-modal" class="btn btn-secondary" data-id="${id}"><i class="fas fa-download"></i> Descargar PDF</button>`
                    });
                    // Evento para el botón de descarga dentro del modal
                    $('#download-btn-modal').click(function() {
                        const id = $(this).data('id');
                        descargarFactura(id);
                    });

                },
                error: function(xhr, status, error) {
                    console.error("Error obteniendo detalles de factura:", error);
                    console.error("Respuesta:", xhr.responseText);

                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudieron cargar los detalles de la factura',
                        confirmButtonColor: '#3085d6'
                    });
                }
            });
        }

        function descargarFactura(number) {
            console.log("Descargando factura número:", number);

            Swal.fire({
                title: 'Generando PDF',
                text: 'Espere por favor...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/api/facturas/factura-download/${number}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token') // Si usas token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Error al descargar el PDF');
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `factura-${number}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    Swal.close();
                })
                .catch(error => {
                    console.error("Error al descargar el PDF:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'No se pudo descargar el PDF. Intente nuevamente.',
                        confirmButtonColor: '#3085d6'
                    });
                });
        }

        function descargarXml(number) {
            console.log("Descargando XML para factura Número:", number);

            if (number === 'N/A' || !number) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el número de la factura',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: 'Cargando XML',
                text: 'Espere por favor...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/api/facturas/descargar-xml/${number}`, {
                method: 'GET'
            })
                .then(response => {
                    console.log("Estado HTTP:", response.status);
                    if (!response.ok) {
                        throw new Error(`Estado ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Convertir el blob a texto
                    return blob.text();
                })
                .then(xmlText => {
                    Swal.close();

                    // Mostrar el XML en una ventana emergente con formato
                    Swal.fire({
                        title: `Vista Previa del XML - Factura ${number}`,
                        html: `<pre style="text-align: left; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">${xmlText}</pre>`,
                        width: '800px', // Ancho personalizado para mejor legibilidad
                        showConfirmButton: true,
                        confirmButtonText: 'Cerrar',
                        confirmButtonColor: '#3085d6',
                        showCancelButton: true,
                        cancelButtonText: 'Descargar',
                        cancelButtonColor: '#28a745',
                        didOpen: () => {
                            // Opcional: Si quieres resaltar el XML con una librería como Prism.js, aquí podrías integrarla
                        }
                    }).then((result) => {
                        // Si el usuario elige "Descargar", ejecutamos la lógica de descarga
                        if (result.dismiss === Swal.DismissReason.cancel) {
                            const blob = new Blob([xmlText], { type: 'application/xml' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `factura-${number}.xml`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => {
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                            }, 100);
                        }
                    });
                })
                .catch(error => {
                    Swal.close();
                    console.error("Error en la solicitud:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar el XML: ' + error.message,
                        confirmButtonColor: '#3085d6'
                    });
                });
        }

        function eliminarFactura(referenceCode) {
            console.log("Eliminando factura Number:", referenceCode);

            if (referenceCode === 'N/A' || !referenceCode) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el referenceCode de la factura',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: '¿Está seguro?',
                text: "Esta acción eliminará la factura permanentemente",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Eliminando',
                        text: 'Espere por favor...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        url: `/api/facturas/eliminar/${referenceCode}`,
                        method: 'DELETE',
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: 'Factura eliminada correctamente',
                                confirmButtonColor: '#28a745'
                            }).then(() => {
                                loadFacturas();
                            });
                        },
                        error: function(xhr) {
                            Swal.close();
                            let errorMessage = xhr.responseJSON?.error || `Error ${xhr.status}: ${xhr.statusText}`;
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: errorMessage,
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    });
                }
            });
        }

        function validateFactura(number) {
            console.log("Validando factura Número:", number);

            if (number === 'N/A' || !number) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el número de la factura',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: '¿Está seguro?',
                text: "Va a validar esta factura en Factus",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, validar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Validando',
                        text: 'Espere por favor...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        url: `/api/facturas/validar-y-descargar/${number}`,
                        method: 'GET',
                        xhrFields: {
                            responseType: 'blob'
                        },
                        success: function(data, status, xhr) {
                            Swal.close();

                            const contentType = xhr.getResponseHeader('Content-Type');
                            if (contentType.includes('application/pdf')) {
                                // Crear una URL temporal para el blob del PDF
                                const blob = new Blob([data], { type: 'application/pdf' });
                                const url = window.URL.createObjectURL(blob);

                                // Mostrar el PDF en una vista previa con Swal
                                Swal.fire({
                                    title: `Vista Previa del PDF - Factura ${number}`,
                                    html: `
                                <iframe src="${url}" width="100%" height="500px" style="border: none;"></iframe>
                            `,
                                    width: '90%',
                                    showConfirmButton: true,
                                    confirmButtonText: 'Cerrar',
                                    confirmButtonColor: '#3085d6',
                                    showCancelButton: true,
                                    cancelButtonText: 'Descargar',
                                    cancelButtonColor: '#28a745',
                                    didClose: () => {
                                        // Liberar la URL cuando se cierre la ventana
                                        window.URL.revokeObjectURL(url);
                                    }
                                }).then((result) => {
                                    // Si el usuario elige "Descargar", ejecutar la descarga
                                    if (result.dismiss === Swal.DismissReason.cancel) {
                                        const a = document.createElement('a');
                                        a.style.display = 'none';
                                        a.href = url;
                                        a.download = `factura-${number}.pdf`;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        // No liberamos la URL aquí porque ya se liberó en didClose
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Respuesta inesperada del servidor: Content-Type no es application/pdf',
                                    confirmButtonColor: '#3085d6'
                                });
                            }
                        },
                        error: function(xhr) {
                            Swal.close();
                            let errorMessage = 'Error desconocido';
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            } else if (xhr.status === 0) {
                                errorMessage = 'No se pudo conectar al servidor';
                            } else {
                                errorMessage = `Error ${xhr.status}: ${xhr.statusText}`;
                            }
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'No se pudo validar la factura: ' + errorMessage,
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    });
                }
            });
        }
        // Función actualizada para guardar producto
        $('#guardar-producto').click(function() {
            const id = $('#producto-id').val();
            // Generar standardCodeId automáticamente (basado en el nombre del producto + timestamp)
            const currentTime = new Date().getTime();
            const nameSanitized = $('#producto-nombre').val().replace(/[^a-zA-Z0-9]/g, '').substring(0, 4).toUpperCase();

            const producto = {
                name: $('#producto-nombre').val(), // Ejemplo: "Smart Watch"
                price: parseFloat($('#producto-precio').val()), // Ejemplo: 1500000
                excluded: $('#producto-excluido').is(':checked'), // Ejemplo: false
                withholdingTaxRate: $('#producto-retencion').val() || "0", // Ejemplo: "0"
                taxRate: parseFloat($('#producto-tasa-iva').val()), // Ejemplo: 19.0
                standardCodeId: `STD-${nameSanitized}-${currentTime}`, // Ejemplo: "STD-SMAR-1698765432109"
                unitMeasureId: $('#producto-medida').val(),  // Ejemplo: "unidad 70"
            };
            // Validación básica
            if (!producto.name || producto.price <= 0 || !producto.taxRate) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre, precio y tasa de IVA son obligatorios y deben ser válidos.'
                });
                return;
            }

            if (id) {
                $.ajax({
                    url: `/api/productos/${id}`,
                    method: 'PUT',
                    data: JSON.stringify(producto),
                    contentType: 'application/json',
                    success: function() {
                        $('#productoModal').modal('hide');
                        loadProductos();
                        swal.fire({
                            toast:true,
                            position:'top-end',
                            icon:'success',
                            title:'Exito',
                            text:'Producto actualizado correctamente',
                            timer:2000,
                            showConfirmButton: false

                        });

                 },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al actualizar producto: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            } else {
                // Crear nuevo producto
                $.ajax({
                    url: '/api/productos',
                    method: 'POST',
                    data: JSON.stringify(producto),
                    contentType: 'application/json',
                    success: function() {
                        $('#productoModal').modal('hide');
                        loadProductos();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Producto creado correctamente',
                            timer:2000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al crear producto: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            }
        });

        // Mostrar/ocultar campos según tipo de cliente
        $('#cliente-tipo').change(function() {
            if ($(this).val() === 'Persona Jurídica') {
                $('#campos-juridica').show();
                // Si cambia a persona jurídica, cambiamos automáticamente a NIT
                $('#cliente-tipo-identificacion').val('NIT');
            } else {
                $('#campos-juridica').hide();
            }
        });

// Inicializar también al abrir el modal
        $('#clienteModal').on('show.bs.modal', function() {
            if ($('#cliente-tipo').val() === 'Persona Jurídica') {
                $('#campos-juridica').show();
            } else {
                $('#campos-juridica').hide();
            }
        });

        $('#guardar-cliente').click(function() {
            const id = $('#cliente-id').val();
            const tipoCliente = $('#cliente-tipo').val();
            const tipoIdentificacion = $('#cliente-tipo-identificacion').val();
            const identificacion = $('#cliente-identificacion').val();

            // Generar legalOrganizationId automáticamente
            let legalOrganizationId;
            if (tipoCliente === 'Persona Jurídica') {
                const companyName = $('#cliente-company').val() || $('#cliente-nombre').val();
                const companyPrefix = companyName.substring(0, 3).toUpperCase();
                legalOrganizationId = `ORG-${companyPrefix}-${new Date().getTime().toString().substring(5)}`;
            } else {
                // Para persona natural
                const namePrefix = $('#cliente-nombre').val().substring(0, 3).toUpperCase();
                legalOrganizationId = `NAT-${namePrefix}-${new Date().getTime().toString().substring(5)}`;
            }

            // Generar tributeId automáticamente
            const tributePrefix = tipoIdentificacion === 'NIT' ? 'TRIB-NIT' : 'TRIB-CC';
            const tributeId = `${tributePrefix}-${identificacion.replace(/[^0-9]/g, '').substring(0, 6)}-${Math.floor(Math.random() * 1000)}`;

            // Crear objeto cliente con todos los campos
            const cliente = {
                nombre: $('#cliente-nombre').val(),
                tipoCliente: tipoCliente,
                tipoIdentificacion: tipoIdentificacion,
                identificacion: identificacion,
                telefono: $('#cliente-telefono').val(),
                correo: $('#cliente-correo').val(),
                municipio: $('#cliente-municipio').val(),
                direccion: $('#cliente-direccion').val(),
                aplicaIVA: $('#cliente-aplica-iva').val(), // Asegúrate de que este campo se esté asignando correctamente
                // Campos automáticos
                legalOrganizationId: id ? $('#cliente-legalOrganizationId').val() : legalOrganizationId,
                tributeId: id ? $('#cliente-tributeId').val() : tributeId
            };
            // Validación básica
            if (!cliente.nombre || !cliente.identificacion || !cliente.tipoCliente) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre, identificación y tipo de cliente son obligatorios.'
                });
                return;
            }

            // Agregar campos específicos para persona jurídica si aplica
            if (tipoCliente === 'Persona Jurídica') {
                cliente.company = $('#cliente-company').val();
                cliente.tradeName = $('#cliente-tradeName').val();
                cliente.verificationDigit = $('#cliente-verificationDigit').val();
                cliente.idOrg = $('#cliente-idOrg').val();
            }

            if (id) {
                // Actualizar cliente
                $.ajax({
                    url: `/api/clientes/${id}`,
                    method: 'PUT',
                    data: JSON.stringify(cliente),
                    contentType: 'application/json',
                    success: function() {
                        $('#clienteModal').modal('hide');
                        loadClientes();
                        swal.fire({
                            toast:true,
                            position:'top-end',
                            icon:'success',
                            title:'Exito',
                            text:'Cliente actualizado correctamente',
                            timer:2000,
                            showConfirmButton: false

                        });                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al actualizar cliente: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            } else {
                // Crear nuevo cliente
                $.ajax({
                    url: '/api/clientes',
                    method: 'POST',
                    data: JSON.stringify(cliente),
                    contentType: 'application/json',
                    success: function() {
                        $('#clienteModal').modal('hide');
                        loadClientes();
                        Swal.fire({
                            toast:true,
                            position:'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Cliente creado correctamente',
                            timer:2000,
                            showConfirmButton: false

                        });
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al crear cliente: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            }
        });


        function editProducto(id) {
            console.log("Fetching product data for ID:", id);

            $.ajax({
                url: `/api/productos/${id}`,
                method: 'GET',
                success: function(producto) {
                    $('#producto-id').val(producto.id);
                    $('#producto-nombre').val(producto.name);
                    $('#producto-precio').val(producto.price);
                    $('#producto-excluido').prop('checked', producto.excluded);
                    $('#producto-retencion').val(producto.withholdingTaxRate);
                    $('#producto-tasa-iva').val(producto.taxRate);

                    // Almacenar los valores existentes para los campos automáticos
                    $('#producto-standardCodeId').val(producto.standardCodeId);
                    $('#producto-unitMeasureId').val(producto.unitMeasureId);

                    $('#productoModalLabel').text('Editar Producto');
                    // Now show the modal
                    $('#productoModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error("Error loading product data:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);

                    let errorMsg = 'Error al cargar el producto';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMsg += ': ' + xhr.statusText;
                    }

                    alert(errorMsg);
                }
            });
        }

        // Función para editar cliente actualizada
        function editCliente(id) {
            console.log("Fetching client data for ID:", id);

            $.ajax({
                url: `/api/clientes/${id}`,
                method: 'GET',
                success: function(cliente) {
                    console.log("Client data received:", cliente);
                    console.log("aplicaIva value:", cliente.aplicaIva, "type:", typeof cliente.aplicaIva);

                    // First clear the form to remove any previous data
                    $('#cliente-form').trigger('reset');

                    // Set the modal title and client ID
                    $('#clienteModalLabel').text('Editar Cliente');
                    $('#cliente-id').val(cliente.id);

                    // Fill in the form fields with client data
                    $('#cliente-tipo').val(cliente.tipoCliente);
                    $('#cliente-tipo-identificacion').val(cliente.tipoIdentificacion);
                    $('#cliente-identificacion').val(cliente.identificacion);
                    $('#cliente-nombre').val(cliente.nombre);
                    $('#cliente-telefono').val(cliente.telefono);
                    $('#cliente-correo').val(cliente.correo);
                    $('#cliente-municipio').val(cliente.municipio);
                    $('#cliente-direccion').val(cliente.direccion);
                    $('#cliente-aplica-iva').val(cliente.aplicaIVA);

                    // Campos automáticos
                    $('#cliente-legalOrganizationId').val(cliente.legalOrganizationId);
                    $('#cliente-tributeId').val(cliente.tributeId);

                    // Campos específicos de persona jurídica
                    if (cliente.tipoCliente === 'Persona Jurídica') {
                        $('#cliente-company').val(cliente.company || '');
                        $('#cliente-tradeName').val(cliente.tradeName || '');
                        $('#cliente-verificationDigit').val(cliente.verificationDigit || '');
                        $('#cliente-idOrg').val(cliente.idOrg || '');
                        $('#campos-juridica').show();
                    } else {
                        $('#campos-juridica').hide();
                    }

                    // Now show the modal
                    $('#clienteModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error("Error loading client data:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);

                    let errorMsg = 'Error al cargar el cliente';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMsg += ': ' + xhr.statusText;
                    }

                    alert(errorMsg);
                }
            });
        }
        // Manejo de facturas
        var itemCount = 0;
        var facturaItems = [];

        function loadClientesFactura(callback) {
            $.ajax({
                url: '/api/clientes',
                method: 'GET',
                success: function(clientes) {
                    // Guardar la lista de clientes en la variable global
                    clientesList = clientes;

                    const select = $('#factura-cliente');
                    select.empty();
                    select.append('<option value="">Seleccionar cliente...</option>');

                    clientes.forEach(function(cliente) {
                        select.append(`<option value="${cliente.id}">${cliente.nombre}</option>`);
                    });

                    // Ejecutar el callback si existe
                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error loading clientes:", error);
                    alert('Error al cargar la lista de clientes');

                    // Ejecutar el callback incluso en caso de error
                    if (typeof callback === 'function') {
                        callback();
                    }
                }
            });
        }

        function onClienteSelected() {
            const clienteId = $('#factura-cliente').val();

            if (!clienteId) {
                clearClienteInfo();
                return;
            }

            // Buscar el cliente seleccionado en la lista global
            const clienteSeleccionado = clientesList.find(c => c.id == clienteId);

            if (clienteSeleccionado) {
                // Rellenar campos de información del cliente
                $('#cliente-nombres').text(clienteSeleccionado.nombre || '-');
                $('#cliente-tipos').text(clienteSeleccionado.tipoCliente || '-');
                $('#cliente-correos').text(clienteSeleccionado.correo || '-');
                $('#cliente-telefonos').text(clienteSeleccionado.telefono || '-');
                $('#cliente-direcciones').text(clienteSeleccionado.direccion || '-');
                $('#cliente-municipios').text(clienteSeleccionado.municipio || '-');

                // Rellenar campos automáticos de la factura
                $('#factura-identification').val(clienteSeleccionado.identificacion || '');
                $('#factura-api-client-name').val(clienteSeleccionado.nombre || '');
                $('#factura-graphic-representation').val('PDF');

                // Generar campos automáticos
                generateAutoFields();
            } else {
                console.error('Cliente no encontrado en la lista');
                clearClienteInfo();
            }
        }

// Limpiar información del cliente
        function clearClienteInfo() {
            $('#cliente-nombre, #cliente-tipo, #cliente-correo, #cliente-telefono, #cliente-direccion, #cliente-municipio').text('-');
            $('#factura-identification, #factura-api-client-name, #factura-graphic-representation').val('');
        }

        // Generar campos automáticos
        function generateAutoFields() {
            // Generar número de factura (prefijo + números aleatorios)
            const facturaNumero = "FAC" + Math.random().toString(36).substring(2, 10).toUpperCase();
            $('#factura-numero').text(facturaNumero);

            // Generar código de referencia único
            const referenceCode = "REF-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
            $('#factura-reference-code').val(referenceCode);
            $('#factura-reference-code-display').text(referenceCode);

            // Generar ID de rango de numeración (número aleatorio)
            const numberingRangeId = Math.floor(Math.random() * 10000) + 1;
            $('#factura-numbering-range-id').val(numberingRangeId);
        }

        function loadProductos(page = 1, itemsPerPage = 6) {
            $.ajax({
                url: '/api/productos',
                method: 'GET',
                success: function(data) {
                    console.log('Productos cargados:', data); // Verifica los datos crudos
                    const tbody = $('#productos-table-body');
                    tbody.empty();

                    // Filtrado por búsqueda
                    const searchTerm = $('#buscar-productos').val().toLowerCase();
                    const filteredData = data.filter(producto =>
                        producto.id.toString().includes(searchTerm) ||
                        producto.name.toLowerCase().includes(searchTerm)
                    );
                    console.log('Productos filtrados:', filteredData);

                    // Paginación
                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    console.log('Total páginas:', totalPages);

                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedData = filteredData.slice(startIndex, endIndex);
                    console.log('Datos paginados (página ' + page + '):', paginatedData);

                    // Llenar tabla
                    paginatedData.forEach(function(producto) {
                        tbody.append(`
                    <tr>
                        <td>${producto.id}</td>
                        <td>${producto.name}</td>
                        <td>$${parseFloat(producto.price).toFixed(2)}</td>
                        <td>${producto.unitMeasureId || 'N/A'}</td>
                        <td>${producto.taxRate ? producto.taxRate + '%' : '0%'}</td>
                        <td>${producto.standardCodeId || 'Auto'}</td>
                        <td>
                            <button class="btn btn-sm btn-primary edit-producto" data-id="${producto.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-producto" data-id="${producto.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `);
                    });

                    // Mostrar mensaje si no hay datos
                    if (paginatedData.length === 0) {
                        tbody.append(`
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h4>No hay productos</h4>
                                <p>No se encontraron productos que coincidan con la búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `);
                    }

                    // Renderizar paginación
                    renderPagination(totalPages, page, 'productos');

                    // Eventos de botones
                    $('.edit-producto').click(function() {
                        const id = $(this).data('id');
                        editProducto(id);
                    });

                    $('.delete-producto').click(function() {
                        const id = $(this).data('id');
                        openDeleteModal('producto', id);
                    });
                },
                error: function(xhr) {
                    console.error('Error al cargar productos:', xhr);
                    $('#productos-table-body').html(`
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        Error al cargar productos
                    </td>
                </tr>
            `);
                }
            });
        }

        function loadProductosSeleccion() {
            $.ajax({
                url: '/api/productos',
                method: 'GET',
                success: function(data) {
                    const tbody = $('#seleccionar-producto-body');
                    tbody.empty();

                    data.forEach(function(producto) {
                        tbody.append(`
                    <tr>
                        <td>${producto.id}</td>
                        <td>${producto.name}</td>
                        <td>$${producto.price}</td>
                        <td>${producto.measureId || 'N/A'}</td>
                        <td>${producto.taxRate || '0'}%</td>
                        <td>
                            <button class="btn btn-sm btn-primary seleccionar-producto"
                                    data-id="${producto.id}"
                                    data-name="${producto.name}"
                                    data-price="${producto.price}"
                                    data-tax-rate="${producto.taxRate || 0}">
                                <i class="fas fa-check"></i> Seleccionar
                            </button>
                        </td>
                    </tr>
                `);
                    });

                    // Agregar evento de selección
                    $('.seleccionar-producto').click(function() {
                        const id = $(this).data('id');
                        const name = $(this).data('name');
                        const price = $(this).data('price');
                        const taxRate = $(this).data('tax-rate');

                        addItemToFactura(id, name, price, taxRate);
                        $('#seleccionarProductoModal').modal('hide');
                    });
                },
                error: function(error) {
                    console.error("Error cargando productos:", error);
                    alert("Error al cargar los productos. Inténtalo de nuevo.");
                }
            });
        }

        function addItemToFactura(id, name, price, taxRate) {
            const item = {
                id: id,
                name: name,
                price: parseFloat(price),
                quantity: 1,
                taxRate: parseFloat(taxRate),
                discount: 0
            };

            itemCount++;
            facturaItems.push(item);

            const subtotal = item.price * item.quantity;
            const discount = subtotal * (item.discount / 100);
            const taxValue = (subtotal - discount) * (item.taxRate / 100);
            const total = subtotal - discount + taxValue;

            $('#factura-items').append(`
        <tr id="item-${itemCount}">
            <td>${item.name}</td>
            <td>
                <input type="number" class="form-control item-quantity" data-index="${facturaItems.length - 1}" value="${item.quantity}" min="1">
            </td>
            <td>$${item.price.toFixed(2)}</td>
            <td>
                <input type="number" class="form-control item-discount" data-index="${facturaItems.length - 1}" value="${item.discount}" min="0" max="100">
            </td>
            <td class="item-subtotal">$${subtotal.toFixed(2)}</td>
            <td class="item-tax">$${taxValue.toFixed(2)}</td>
            <td class="item-total">$${total.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-danger remove-item" data-index="${facturaItems.length - 1}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `);
            updateFacturaTotals();

            // Agregar eventos a los controles
            $('.item-quantity, .item-discount').on('change', function() {
                const index = $(this).data('index');
                updateItemCalculations(index);
            });

            $('.remove-item').click(function() {
                const index = $(this).data('index');
                removeFacturaItem(index);
            });
        }

        function updateItemCalculations(index) {
            const item = facturaItems[index];
            item.quantity = parseFloat($('.item-quantity[data-index="' + index + '"]').val()) || 1;
            item.discount = parseFloat($('.item-discount[data-index="' + index + '"]').val()) || 0;

            const subtotal = item.price * item.quantity;
            const discount = subtotal * (item.discount / 100);
            const taxValue = (subtotal - discount) * (item.taxRate / 100);
            const total = subtotal - discount + taxValue;

            const row = $('#factura-items tr').eq(index);
            row.find('.item-subtotal').text('$' + subtotal.toFixed(2));
            row.find('.item-tax').text('$' + taxValue.toFixed(2));
            row.find('.item-total').text('$' + total.toFixed(2));

            updateFacturaTotals();
        }

        function removeFacturaItem(index) {
            facturaItems.splice(index, 1);
            $('#factura-items tr').eq(index).remove();

            // Actualizar los índices de los elementos restantes
            $('#factura-items tr').each(function(i) {
                $(this).find('.item-quantity').data('index', i);
                $(this).find('.item-discount').data('index', i);
                $(this).find('.remove-item').data('index', i);
            });

            updateFacturaTotals();
        }

        function updateFacturaTotals() {
            let subtotal = 0;
            let totalIva = 0;
            let totalDescuento = 0;
            let total = 0;

            facturaItems.forEach(function(item) {
                const itemSubtotal = item.price * item.quantity;
                const itemDiscount = itemSubtotal * (item.discount / 100);
                const itemTax = (itemSubtotal - itemDiscount) * (item.taxRate / 100);

                subtotal += itemSubtotal;
                totalDescuento += itemDiscount;
                totalIva += itemTax;
                total += itemSubtotal - itemDiscount + itemTax;
            });

            $('#factura-subtotal').text('$' + subtotal.toFixed(2));
            $('#factura-iva-total').text('$' + totalIva.toFixed(2));
            $('#factura-descuento-total').text('$' + totalDescuento.toFixed(2));
            $('#factura-total').text('$' + total.toFixed(2));
        }
        // Modificación de la función guardar factura
        $('#guardar-factura').click(function() {
            if (facturaItems.length === 0) {
                alert('Debe agregar al menos un producto a la factura');
                return;
            }

            const clienteId = $('#factura-cliente').val();

            if (!clienteId) {
                alert('Debe seleccionar un cliente');
                return;
            }

            // Get the factura ID from your hidden field
            const id = $('#factura-id').val();


            // Obtener cliente seleccionado
            const clienteSeleccionado = clientesList.find(c => c.id == clienteId);
            const factura = {
                cliente: {
                    id: clienteSeleccionado.id,
                    nombre: clienteSeleccionado.nombre,
                    correo: clienteSeleccionado.correo,
                    direccion: clienteSeleccionado.direccion,
                    tipoCliente: clienteSeleccionado.tipoCliente,
                    identificacion: clienteSeleccionado.identificacion,
                },
                documentName: $('#factura-document-name').val(), // "Factus"
                graphicRepresentationName: "PDF",
                formaPago: $('#factura-forma-pago').val(), // Ejemplo: "Contado"
                metodo: $('#factura-metodo-pago').val(), // Ejemplo: "Efectivo"
                createdAt: new Date().toISOString(),
                document: $('#factura-document').val(), // "Factura electrónica de venta"
                numberingRangeId: parseInt($('#factura-numbering-range-id').val()) || 128,
                referenceCode: $('#factura-reference-code').val(), // Ejemplo: "REF-1698765432109-456"
                observation: $('#factura-observation').val(), // Ejemplo: "Cliente capacitado"
                subtotal: parseFloat($('#factura-subtotal').text().replace('$', '')),
                totalIva: parseFloat($('#factura-iva-total').text().replace('$', '')),
                totalDescuento: parseFloat($('#factura-descuento-total').text().replace('$', '')),
                total: parseFloat($('#factura-total').text().replace('$', '')),
                items: facturaItems.map(item => ({
                    producto: {
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        taxRate: item.taxRate
                    },
                    cantidad: item.quantity,
                    precio: item.price,
                    porcentajeDescuento: item.discount,
                    subtotal: item.price * item.quantity,
                    iva: (item.price * item.quantity * (item.taxRate / 100)),
                    total: (item.price * item.quantity) - (item.price * item.quantity * (item.discount / 100)) + (item.price * item.quantity * (item.taxRate / 100))
                }))
            };

// Crear nueva factura
            $.ajax({
                url: '/api/facturas/crear',
                method: 'POST',
                data: JSON.stringify(factura),
                contentType: 'application/json',
                success: function(response) {
                    $('#facturaModal').modal('hide');
                    loadFacturas(); // Recargar lista de facturas
                    Swal.fire({
                        toast:true,
                        position:'top-end',
                        icon: 'success',
                        title: 'Éxito',
                        text: 'Documento con el código de referencia registrado y validado con éxito',
                        confirmButtonColor: '#3085d6',
                        timer:3000,
                        showConfirmButton: false

                    });
                },
                error: function(xhr, status, error) {
                    let errorMsg = 'Error al crear la factura';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg += ': ' + xhr.responseJSON.error; // Mostrar el mensaje detallado del backend
                    } else {
                        errorMsg += ': ' + (xhr.statusText || 'Error desconocido');
                    }

                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: errorMsg,
                        confirmButtonColor: '#d33'
                    });

                    console.error("Error completo:", xhr.responseText);
                    console.error("Estado:", status);
                    console.error("Error:", error);
                }
            });
            console.log("Enviando factura:", JSON.stringify(factura));

            if (id) {
                // Actualizar factura
                $.ajax({
                    url: `/api/facturas/${id}`,
                    method: 'PUT',
                    data: JSON.stringify(factura),
                    contentType: 'application/json',
                    success: function(response) {
                        $('#facturaModal').modal('hide');
                        loadFacturas();
                        Swal.fire({
                            toast:true,
                            position:'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Documento con el código de referencia actualizado con exito',
                            confirmButtonColor: '#3085d6',
                            timer:3000,
                            showConfirmButton: false

                        });
                        },
                    error: function(xhr) {
                        let errorMsg = 'Error al actualizar factura';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        }
                        alert(errorMsg);
                        console.error("Error completo:", xhr.responseText);
                    }
                });
            } else {

            }
        });

        function editFactura(id) {
            console.log("Fetching invoice data for ID:", id);

            // Primero, obtener la factura
            $.ajax({
                url: `/api/facturas/${id}`,
                method: 'GET',
                success: function(factura) {
                    console.log("Invoice data received:", factura);

                    // Actualizar título y ID
                    $('#facturaModalLabel').text('Editar Factura');
                    $('#factura-id').val(factura.id);

                    // Cargar todos los clientes primero
                    $.ajax({
                        url: '/api/clientes',
                        method: 'GET',
                        success: function(clientes) {
                            // Llenar el dropdown de clientes
                            const select = $('#factura-cliente');
                            select.empty();
                            select.append('<option value="">Seleccionar cliente...</option>');

                            clientes.forEach(function(cliente) {
                                select.append(`<option value="${cliente.id}">${cliente.nombre}</option>`);
                            });

                            // Ahora seleccionar el cliente de la factura
                            const clientId = factura.clienteId || (factura.cliente ? factura.cliente.id : null);

                            if (clientId) {
                                console.log("Setting client ID:", clientId);
                                $('#factura-cliente').val(clientId);

                                // Si no se seleccionó correctamente, intentar buscar por nombre
                                if ($('#factura-cliente').val() != clientId && factura.cliente) {
                                    $('#factura-cliente option').each(function() {
                                        if ($(this).text().includes(factura.cliente.nombre)) {
                                            $(this).prop('selected', true);
                                            return false; // Salir del bucle
                                        }
                                    });
                                }
                            }

                            // Activar el evento de selección del cliente para actualizar la información
                            $('#factura-cliente').trigger('change');

                            // Actualizar información del cliente visible directamente
                            if (factura.cliente) {
                                $('#cliente-nombres').text(factura.cliente.nombre || '-');
                                $('#cliente-tipos').text(factura.cliente.tipoCliente || '-');
                                $('#cliente-correos').text(factura.cliente.correo || '-');
                                $('#cliente-telefonos').text(factura.cliente.telefono || '-');
                                $('#cliente-direcciones').text(factura.cliente.direccion || '-');
                                $('#cliente-municipios').text(factura.cliente.municipio || '-');
                            }

                            // Establecer los demás campos de la factura
                            // Forma de pago y metodo de pago
                            $('#factura-forma-pago').val(factura.formaPago);
                            $('#factura-metodo-pago').val(factura.metodo);

                            // Fecha principal de la factura
                            if (factura.fecha) {
                                const fechaStr = factura.fecha.split('T')[0];
                                $('#factura-fecha').val(fechaStr);
                            }

                            // Establecer campos automáticos
                            $('#factura-status').text(factura.status || 'PENDIENTE');
                            $('#factura-numero').text(factura.number || 'N/A');
                            $('#factura-reference-code').val(factura.referenceCode || '');
                            $('#factura-reference-code-display').text(factura.referenceCode || '-');
                            $('#factura-numbering-range-id').val(factura.numberingRangeId || '');
                            $('#factura-observation').val(factura.observation || '');
                            $('#factura-document').val(factura.document || '');
                            $('#factura-document-display').text(factura.document || 'Factura electrónica de venta');

                            // Establecer campos de identificación
                            $('#factura-identification').val(factura.identification || '');
                            $('#factura-api-client-name').val(factura.apiClientName || '');
                            $('#factura-graphic-representation').val(factura.graphicRepresentationName || '');
                            $('#factura-document-name').val(factura.documentName || 'Factus');

                            // Establecer valores numéricos totales
                            $('#factura-subtotal').text(factura.subtotal ? formatCurrency(factura.subtotal) : '$0.00');
                            $('#factura-iva-total').text(factura.totalIva ? formatCurrency(factura.totalIva) : '$0.00');
                            $('#factura-descuento-total').text(factura.totalDescuento ? formatCurrency(factura.totalDescuento) : '$0.00');
                            $('#factura-total').text(factura.total ? formatCurrency(factura.total) : '$0.00');

                            // Limpiar items existentes
                            $('#factura-items').empty();
                            facturaItems = [];
                            itemCount = 0;

                            // Cargar items de la factura
                            console.log("Loading invoice items:", factura.items);

                            if (factura.items && factura.items.length > 0) {
                                factura.items.forEach(function(item) {
                                    if (item.producto) {
                                        addItemToFactura(
                                            item.producto.id,
                                            item.producto.name,
                                            item.precio,
                                            item.producto.taxRate || 0
                                        );

                                        // Actualizar cantidad y descuento
                                        const index = facturaItems.length - 1;
                                        facturaItems[index].quantity = item.cantidad;
                                        facturaItems[index].discount = item.porcentajeDescuento || 0;

                                        $('.item-quantity[data-index="' + index + '"]').val(item.cantidad);
                                        $('.item-discount[data-index="' + index + '"]').val(item.porcentajeDescuento || 0);

                                        updateItemCalculations(index);
                                    } else {
                                        console.error("Item missing product data:", item);
                                    }
                                });
                            } else {
                                console.warn("No items found in invoice or items array is empty");
                            }

                            // Mostrar el modal
                            $('#facturaModal').modal('show');
                        },
                        error: function(xhr, status, error) {
                            console.error("Error loading clientes:", error);
                            alert('Error al cargar la lista de clientes');
                        }
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error loading invoice data:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);

                    let errorMsg = 'Error al cargar la factura';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMsg += ': ' + xhr.statusText;
                    }

                    alert(errorMsg);
                }
            });
        }
// Helper function to format currency values
        function formatCurrency(value) {
            return '$' + Number(value).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }


        function obtenerItems() {
            var items = [];
            $('#factura-items tr').each(function() {
                var item = {
                    producto: {
                        id: $(this).data('producto-id')
                    },
                    cantidad: parseFloat($(this).find('.item-cantidad').text()),
                    precio: parseFloat($(this).find('.item-precio').text()),
                    porcentajeDescuento: parseFloat($(this).find('.item-descuento').text()),
                    subtotal: parseFloat($(this).find('.item-subtotal').text()),
                    iva: parseFloat($(this).find('.item-iva').text()),
                    total: parseFloat($(this).find('.item-total').text())
                };
                items.push(item);
            });
            return items;
        }

        // Eliminar elementos
        function openDeleteModal(type, id) {
            $('#delete-type').val(type);
            $('#delete-id').val(id);
            $('#confirmDeleteModal').modal('show');
        }

        $('#confirmar-eliminacion').click(function() {
            const type = $('#delete-type').val();
            const id = $('#delete-id').val();

            let url = '';
            let refreshFunction = null;

            switch(type) {
                case 'producto':
                    url = `/api/productos/${id}`;
                    refreshFunction = loadProductos;
                    break;
                case 'cliente':
                    url = `/api/clientes/${id}`;
                    refreshFunction = loadClientes;
                    break;
                case 'factura':
                    url = `/api/facturas/${id}`;
                    refreshFunction = loadFacturas;
                    break;
            }

            $.ajax({
                url: url,
                method: 'DELETE',
                success: function() {
                    $('#confirmDeleteModal').modal('hide');
                    refreshFunction();
                    Swal.fire({
                        toast:true,
                        position:'top-end',
                        icon: 'success',
                        title: 'Éxito',
                        text: `${type.charAt(0).toUpperCase() + type.slice(1)} eliminado correctamente`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                    },
                error: function(error) {
                    alert(`Error al eliminar ${type}: ${error.responseJSON.message}`);
                }
            });
        });

        // Inicialización de modales
        $('#productoModal').on('show.bs.modal', function(e) {
            // Only reset the form if it's a new product (not an edit operation)
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-producto')) {
                $('#productoModalLabel').text('Nuevo Producto');
                $('#producto-form').trigger('reset');
                $('#producto-id').val('');
            }
        });

        // Update modal initialization
        $('#clienteModal').on('show.bs.modal', function(e) {
            // Only reset the form if it's a new client (not an edit operation)
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-cliente')) {
                $('#clienteModalLabel').text('Nuevo Cliente');
                $('#cliente-form').trigger('reset');
                $('#cliente-id').val('');
            }
        });

// Modificar la función que muestra el modal
        $('#facturaModal').on('show.bs.modal', function (e) {
            // Limpiar el formulario si es una nueva factura
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-factura')) {
                $('#facturaModalLabel').text('Nueva Factura');
                $('#factura-form').trigger('reset');
                $('#factura-id').val('');
                $('#factura-items').empty();
                facturaItems = [];
                itemCount = 0;
                updateFacturaTotals();

                // Limpiar información del cliente
                clearClienteInfo();

                // Cargar clientes
                loadClientesFactura(function() {
                    // Configurar el evento de selección del cliente
                    $('#factura-cliente').off('change').on('change', function() {
                        onClienteSelected();
                    });
                });

                // Establecer fecha actual
                const today = new Date();
                const yyyy = today.getFullYear();
                let mm = today.getMonth() + 1;
                let dd = today.getDate();

                if (dd < 10) dd = '0' + dd;
                if (mm < 10) mm = '0' + mm;

                $('#factura-fecha').val(yyyy + '-' + mm + '-' + dd);
            }
        });
        // Agregar producto a factura
        $('#agregar-item').click(function() {
            loadProductosSeleccion();
            $('#seleccionarProductoModal').modal('show');
        });

        $('#buscar-producto').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();
            let found = false;

            $('#seleccionar-producto-body tr').each(function() {
                const name = $(this).find('td:eq(1)').text().toLowerCase();
                const id = $(this).find('td:eq(0)').text().toLowerCase();

                if (name.includes(searchTerm) || id.includes(searchTerm)) {
                    $(this).show();
                    found = true;
                } else {
                    $(this).hide();
                }
            });

            // Mostrar mensaje si no hay resultados
            if (!found) {
                $('#seleccionar-producto-body').append(`
            <tr id="no-results">
                <td colspan="6" class="text-center text-muted">No se encontraron productos</td>
            </tr>
        `);
            } else {
                $('#no-results').remove();
            }
        });

        // Cargar dashboard al inicio
        loadDashboardStats();
    });
</script>