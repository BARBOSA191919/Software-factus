<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Facturación</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="https://i.ibb.co/r21Tj1nF/icon-halltec.png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">


<style>

    /* General Reset and Base Styles */
    body {
        font-family: 'Montserrat', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        letter-spacing: 0.2px;
        transition: background-color 0.5s ease;


    }

    h1, h2, h3, h4, h5, h6, .factus-footer h3 {
        font-family: 'Playfair Display', serif;
        letter-spacing: 0.5px;
        position: relative;
        overflow: hidden;
        text-align: center; /* Añade esta línea */
        width: 100%; /* Asegura que ocupe todo el ancho */
    }

    /* Efecto de subrayado animado para encabezados */
    .header-section h2 {
        display: inline-block;
        position: relative;
    }

    .header-section h2::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 0;
        height: 3px;
        background: linear-gradient(90deg, #1e3a8a, #3b82f6);
        transition: width 0.6s ease;
        border-radius: 3px;
    }

    .header-section h2:hover::after {
        width: 100%;
    }

    /* Animación de entrada para las cards */
    .card {
        animation: fadeInUp 0.5s ease forwards;
        opacity: 0;
        transform: translateY(20px);
    }

    @keyframes fadeInUp {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Efecto de hover mejorado para cards */
    .card {
        transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 25px rgba(0, 0, 0, 0.1);
    }

    /* Efecto de brillo en cards al hacer hover */
    .card::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
        transform: rotate(30deg);
        transition: transform 0.8s ease;
        pointer-events: none;
        opacity: 0;
    }

    .card:hover::before {
        opacity: 1;
        transform: rotate(0deg);
    }

    /* Números con efecto de contador */
    .card-text.h3 {
        counter-reset: value;
        display: inline-block;
        position: relative;
    }

    .card-text.h3.animated-number {
        animation: countUp 1.5s ease-out forwards;
    }

    @keyframes countUp {
        from {
            opacity: 0.5;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Animación para filas de tablas */
    .table tbody tr {
        transition: transform 0.2s ease, background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: rgba(59, 130, 246, 0.05) !important;
        transform: scale(1.01);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 2;
    }

    /* Indicador de activo con efecto pulsante */
    .table .active-status {
        display: inline-block;
        width: 12px;
        height: 12px;
        background-color: #38a169;
        border-radius: 50%;
        margin-right: 5px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            box-shadow: 0 0 0 0 rgba(56, 161, 105, 0.7);
        }
        70% {
            box-shadow: 0 0 0 10px rgba(56, 161, 105, 0);
        }
        100% {
            box-shadow: 0 0 0 0 rgba(56, 161, 105, 0);
        }
    }

    /* Botones con efecto de onda */
    .btn {
        position: relative;
        overflow: hidden;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

    .btn:after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 5px;
        height: 5px;
        background: rgba(255, 255, 255, 0.5);
        opacity: 0;
        border-radius: 100%;
        transform: scale(1, 1) translate(-50%);
        transform-origin: 50% 50%;
    }

    .btn:focus:not(:active)::after {
        animation: ripple 1s ease-out;
    }

    @keyframes ripple {
        0% {
            transform: scale(0, 0);
            opacity: 1;
        }
        20% {
            transform: scale(25, 25);
            opacity: 1;
        }
        100% {
            opacity: 0;
            transform: scale(40, 40);
        }
    }


    @keyframes float {
        0% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
        100% {
            transform: translateY(0px);
        }
    }

    /* Efecto de typing para el título principal */
    .typing-effect {
        display: inline-block;
        overflow: hidden;
        border-right: 2px solid #3b82f6;
        white-space: nowrap;
        margin: 0;
        animation: typing 3.5s steps(40, end), blink-caret 0.75s step-end infinite;
    }

    @keyframes typing {
        from { width: 0 }
        to { width: 100% }
    }

    @keyframes blink-caret {
        from, to { border-color: transparent }
        50% { border-color: #3b82f6 }
    }

    /* Barra de búsqueda con animación */
    .search-box {
        transition: all 0.3s ease;
        border-radius: 30px;
        overflow: hidden;
    }

    .search-box:focus-within {
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        transform: translateY(-2px);
    }

    .search-input {
        transition: all 0.3s ease;
    }

    .search-icon {
        transition: all 0.3s ease;
    }

    .search-box:focus-within .search-icon {
        color: #3b82f6;
        transform: scale(1.1);
    }

    /* Animación para menú de navegación */
    .nav-link {
        position: relative;
        transition: all 0.3s ease;
    }

    .nav-link::before {
        content: '';
        position: absolute;
        left: 0;
        bottom: 0;
        height: 2px;
        width: 0;
        background-color: white;
        transition: width 0.3s ease;
    }

    .nav-link:hover::before {
        width: 100%;
    }

    .nav-link.active::before {
        background-color: #1e3a8a;
        width: 100%;
    }

    /* Animación para modales */
    .modal.fade .modal-dialog {
        transform: scale(0.9);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease;
    }

    .modal.show .modal-dialog {
        transform: scale(1);
        opacity: 1;
    }
    .container-fluid {
        padding: 0;
    }

    /* Sidebar */
    .sidebar {
        min-height: 100vh;
        background: linear-gradient(180deg, #1e40af 0%, #1e3a8a 100%);
        border-right: 1px solid #2c5282;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        padding-top: 20px;
        position: fixed;
        grid-column: 1;
        width: 250px;
        transition: width 0.3s ease;
        z-index: 1000;


    }
    /* Estilos para el botón de la flecha */
    .sidebar-toggle {
        position: absolute;
        top: 20px;
        right: -40px;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 101;
        transition: all 0.3s ease;
    }

    .sidebar-toggle i {
        font-size: 1.2rem;
    }

    /* Sidebar cerrada */
    .sidebar.collapsed {
        width: 80px;
    }

    .sidebar.collapsed h4,
    .sidebar.collapsed .nav-link span,
    .sidebar.collapsed .btn-danger span {
        display: none;
    }

    .sidebar.collapsed .nav-link {
        padding: 12px;
        justify-content: center;
    }

    .sidebar.collapsed .nav-link i {
        margin-right: 0;
        font-size: 1.25rem;
    }

    .sidebar.collapsed .btn-danger {
        padding: 12px;
        display: flex;
        justify-content: center;
    }

    /* Ajustar contenido cuando la sidebar está cerrada */
    .content.collapsed {
        margin-left: 80px;
    }

    /* Rotar flecha cuando la sidebar está cerrada */
    .sidebar.collapsed .sidebar-toggle i {
        transform: rotate(180deg);
    }

    /* Transiciones suaves */
    .sidebar, .content {
        transition: all 0.3s ease;
    }

    .sidebar h4 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 2rem;
        text-align: center;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        color: #e2e8f0;
        font-weight: 500;
        border-radius: 8px;
        margin: 4px 10px;
        transition: all 0.2s ease;
    }

    .nav-link i {
        margin-right: 10px;
        font-size: 1.2rem;
    }

    .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    .nav-link.active {
        background-color: #ffffff;
        color: #1e3a8a;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* Logout Button */
    .sidebar .btn-danger {
        margin: 20px 10px;
        padding: 12px;
        font-weight: 500;
        border-radius: 8px;
        background-color: #e53e3e;
        border-color: #e53e3e;
        transition: background-color 0.2s ease;
    }

    .sidebar .btn-danger:hover {
        background-color: #c53030;
        border-color: #c53030;
    }

    /* Ajustar contenido principal */
    .content {
        margin-left: 250px;
        padding: 30px;
        background-color: #f0f4f8;
        min-height: 100vh;
        position: relative;
        transition: margin-left 0.3s ease; /* Añadir transición para suavizar el cambio */
    }
    /* Cuando el sidebar está colapsado */
    .sidebar.collapsed + .content {
        margin-left: 80px;
        width: calc(100% - 80px);

    }

    /* Para pantallas pequeñas donde el sidebar se oculta completamente */
    @media (max-width: 768px) {
        .sidebar.collapsed + .content {
            margin-left: 0;
        }
    }
    .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2d3748;
    }

    .card-text.h3 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a202c;
    }

    /* Asegurar que la tabla no interfiera con el dropdown */
    .table {
        width: 100%;
        font-size: 0.9rem;
        border-collapse: separate;
        border-spacing: 0;
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border-radius: 8px;
        position: relative;
        z-index: 1; /* Bajo para no interferir con el dropdown */
    }

    /* Estilo para columnas específicas */
    .table th:nth-child(1), .table td:nth-child(1) { /* Número */
        max-width: none; /* Remove max-width constraint to allow full display */
        white-space: normal; /* Allow text to wrap if needed */
        text-overflow: clip; /* Remove ellipsis */
        overflow: visible; /* Allow content to overflow if necessary */
    }
    .table th:nth-child(3), .table td:nth-child(3) { /* ID */
        max-width: 100px;
    }
    .table th:nth-child(5), .table td:nth-child(5) { /* Método */
        max-width: 120px;
    }

    .table thead {
        background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 100%);
        color: white;
    }

    /* Ajustar el tamaño y comportamiento de las celdas de la tabla */
    .table th, .table td {
        padding: 8px 10px;
        vertical-align: middle;
        text-align: left;
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
        max-width: 180px;
    }


    .table th {
        background-color: #1e3a8a;
        color: white;
        font-weight: 600;
    }



    /* Ajustar botones de acción */
    .table .btn {
        padding: 4px 8px;
        font-size: 0.85rem;
    }

    /* Asegurar que las filas de la tabla no tengan overflow */
    .table tbody tr {
        position: relative;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f9fafb;
    }

    .table-hover tbody tr:hover {
        background-color: #eff6ff;
    }

    .table-responsive {
        overflow-x: auto; /* Mantener solo el scroll horizontal si es necesario */
        position: relative;
    }
    /* Estilo específico para los dropdowns en tablas */
    .table .dropdown {
        position: static;  /* Importante para evitar que se recorte */
    }

    .table .dropdown-menu {
        position: absolute !important;
        right: 0;
        left: auto !important;
        min-width: 150px;
        z-index: 1500 !important;  /* Z-index alto para asegurar que aparezca encima */
        transform: none !important;  /* Evitar transformaciones que afecten la posición */
    }

    /* Para dispositivos móviles */
    @media (max-width: 768px) {
        .table .dropdown-menu {
            position: fixed !important;
            top: auto !important;
            left: 10% !important;
            right: 10% !important;
            width: 80%;
            max-width: 300px;
            margin: 0 auto;
        }
    }

    .action-buttons {
        display: flex;
        gap: 6px;
        justify-content: center;
        flex-wrap: wrap;
    }


    .action-buttons .btn {
        padding: 4px 8px;
        font-size: 14px;
        line-height: 1;
    }

    .action-buttons.factura-actions .btn {
        padding: 2px;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border-radius: 4px;
    }

    .action-buttons .btn i {
        margin: 0;
    }

    [data-bs-toggle="tooltip"] {
        cursor: pointer;
    }

    @media (max-width: 768px) {
        .action-buttons .btn {
            padding: 3px 6px;
            font-size: 12px;
        }
        .action-buttons.factura-actions .btn {
            width: 20px;
            height: 20px;
            font-size: 10px;
        }
    }
    .dropdown {
        position: relative;
        z-index: 1050 !important;
    }

    .dropdown-menu {
        z-index: 1050 !important;
        min-width: 180px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-top: 5px;
    }
    /* Estilo para los ítems del menú */
    .dropdown-item {
        font-size: 0.9rem;
        padding: 8px 12px;
    }
    .dropdown-item i {
        margin-right: 8px;
    }
    /* Asegurar que el botón del dropdown esté correctamente posicionado */
    .dropdown-toggle {
        position: relative;
    }
    /* Estilo para dropdown compacto */
    .dropdown .btn-light.dropdown-toggle {
        background: transparent;
        border: none;
        color: #6c757d;
        padding: 2px 4px !important;
        width: 28px;
        height: 28px;
    }

    .dropdown .btn-light.dropdown-toggle:hover {
        background-color: #f8f9fa;
        color: #495057;
    }

    /* Estilo para el menú compacto */
    .dropdown-menu.compact-menu {
        min-width: 40px !important;
        padding: 0.25rem 0;
        font-size: 0.875rem;
    }

    .dropdown-menu.compact-menu .dropdown-item {
        padding: 4px 8px;
        text-align: center;
    }

    .dropdown-menu.compact-menu .dropdown-item i {
        margin-right: 0;
        font-size: 0.9rem;
    }

    /* Tooltip para mostrar texto en hover */
    [data-bs-toggle="tooltip"] {
        cursor: pointer;
    }
    .dropdown-menu.show {
        display: block !important;
        z-index: 1050 !important;
        position: absolute !important;
    }
    /* Buttons */
    .btn-primary {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        border-color: #2563eb;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 500;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .btn-primary:hover, .btn-primary:focus {
        background: linear-gradient(135deg, #1e4620 0%, #2563eb 100%);
        border-color: #1e40af;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(37, 99, 235, 0.25);
    }

    .btn-success {
        background: linear-gradient(135deg, #047857 0%, #10b981 100%);
        border-color: #059669;
        box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
    }

    .btn-success:hover, .btn-success:focus {
        background: linear-gradient(135deg, #065f46 0%, #059669 100%);
        border-color: #047857;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
    }

    .btn-danger {
        background: linear-gradient(135deg, #b91c1c 0%, #ef4444 100%);
        border-color: #dc2626;
        box-shadow: 0 2px 4px rgba(239, 68, 68, 0.2);
    }

    .btn-danger:hover, .btn-danger:focus {
        background: linear-gradient(135deg, #991b1b 0%, #dc2626 100%);
        border-color: #b91c1c;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(239, 68, 68, 0.25);
    }

    .btn-info {
        background: linear-gradient(135deg, #0284c7 0%, #38bdf8 100%);
        border-color: #0ea5e9;
        color: white !important;
        box-shadow: 0 2px 4px rgba(56, 189, 248, 0.2);
    }

    .btn-info:hover, .btn-info:focus {
        background: linear-gradient(135deg, #0369a1 0%, #0ea5e9 100%);
        border-color: #0284c7;
        color: white !important;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(56, 189, 248, 0.25);
    }

    .btn-secondary {
        background: linear-gradient(135deg, #475569 0%, #64748b 100%);
        border-color: #64748b;
        box-shadow: 0 2px 4px rgba(100, 116, 139, 0.2);
    }

    .btn-secondary:hover, .btn-secondary:focus {
        background: linear-gradient(135deg, #334155 0%, #475569 100%);
        border-color: #475569;
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(100, 116, 139, 0.25);
    }

    .btn i {
        margin-right: 6px;
    }

    /* Modals */
    .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }

    .modal-header {
        border-bottom: 1px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    .modal-header.bg-primary, .modal-header.bg-success, .modal-header.bg-info, .modal-header.bg-danger {
        background: linear-gradient(90deg, #1e3a8a 0%, #2563eb 100%) !important;
    }

    .modal-header.bg-success {
        background: linear-gradient(90deg, #047857 0%, #10b981 100%) !important;
    }

    .modal-header.bg-info {
        background: linear-gradient(90deg, #0284c7 0%, #38bdf8 100%) !important;
    }

    .modal-header.bg-danger {
        background: linear-gradient(90deg, #b91c1c 0%, #ef4444 100%) !important;
    }

    .modal-title {
        font-weight: 500;
        color: white;
        display: flex;
        align-items: center;
    }

    .modal-title i {
        margin-right: 8px;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-footer {
        border-top: 2px solid #e2e8f0;
        padding: 1.25rem 1.5rem;
    }

    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #d1d5db;
        padding: 10px 12px;
        font-size: 0.95rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25);
    }

    /* Dashboard Cards */
    .card.bg-primary {
        background: linear-gradient(45deg, #1e40af, #3b82f6) !important;
        border: none;
    }

    .card.bg-success {
        background: linear-gradient(45deg, #047857, #10b981) !important;
        border: none;
    }

    .card.bg-info {
        background: linear-gradient(45deg, #0284c7, #38bdf8) !important;
        border: none;
    }

    /* Input Groups */
    .input-group-text {
        background-color: #f1f5f9;
        border-color: #d1d5db;
        color: #64748b;
    }

    .search-box .form-control {
        padding-left: 40px;
        background-color: white;
        border: 1px solid #e2e8f0;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .search-box .search-icon {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #64748b;
        z-index: 10;
    }


    .page-item:first-child .page-link {
        border-top-left-radius: 8px;
        border-bottom-left-radius: 8px;
    }

    .page-item:last-child .page-link {
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
    }

    .page-item.active .page-link {
        background-color: #1e40af;
        border-color: #1e40af;
    }

    .page-item.disabled .page-link {
        color: #94a3b8;
        background-color: #f8fafc;
        border-color: #e2e8f0;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
        .sidebar {
            width: 80px;
        }

        .sidebar h4, .sidebar .nav-link span, .sidebar .btn-danger span {
            display: none;
        }

        .sidebar .nav-link {
            padding: 12px;
            justify-content: center;
        }

        .sidebar .nav-link i {
            margin-right: 0;
            font-size: 1.25rem;
        }

        .sidebar .btn-danger {
            padding: 12px;
            display: flex;
            justify-content: center;
        }

        .content {
            margin-left: 80px;
        }
    }

    @media (max-width: 768px) {
        .content {
            margin-left: 0;
            padding: 16px;
        }
        /* Asegurar que en pantallas pequeñas el dropdown sea visible */
        @media (max-width: 768px) {
            .table th, .table td {
                padding: 6px 8px;
                font-size: 0.85rem;
                max-width: 100px;
            }
            .table th:nth-child(1), .table td:nth-child(1) {
                max-width: 60px;
            }
            .dropdown-menu {
                z-index: 9999 !important; /* Mantener z-index alto */
                position: fixed !important; /* Forzar posicionamiento absoluto */
                transform: translateY(5px); /* Mantener debajo del botón */
            }
        }

        .sidebar {
            width: 100%;
            height: auto;
            position: relative;
            min-height: 0;
            display: flex;
            justify-content: center;
            padding: 10px;
        }

        .sidebar .nav {
            display: flex;
            flex-direction: row;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .sidebar h4 {
            margin-bottom: 0;
            margin-right: 15px;
            display: block;
        }

        .sidebar .nav-link {
            padding: 8px 12px;
            margin: 2px 5px;
        }

        .sidebar .btn-danger {
            margin: 2px 5px;
            padding: 8px 12px;
        }

        .card {
            margin-bottom: 16px;
        }
    }

    @keyframes rotation {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }


    .empty-state i {
        font-size: 3rem;
        color: #cbd5e1;
        margin-bottom: 1.5rem;
    }

    .empty-state h4 {
        color: #475569;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .empty-state p {
        color: #64748b;
        max-width: 500px;
        margin: 0 auto 1.5rem;
    }
    .search-container {
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
    }

    .search-box {
        position: relative;
        display: flex;
        align-items: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-radius: 25px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .search-box:hover, .search-box:focus-within {
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .search-icon {
        position: absolute;
        left: 20px;
        color: #6c757d;
        font-size: 16px;
        z-index: 1;
    }

    .search-input {
        width: 100%;
        padding: 15px 20px 15px 50px;
        border: 1px solid #e0e0e0;
        border-radius: 25px;
        font-size: 15px;
        color: #333;
        transition: all 0.3s ease;
    }

    .search-input:focus {
        outline: none;
        border-color: #4a90e2;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .search-input::placeholder {
        color: #9e9e9e;
        font-style: italic;
    }
    /* Hacer las tarjetas clicables */
    .clickable-card {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .clickable-card:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    /* Estilos para el footer con el logo */
    .factus-footer {
        padding: 30px 0;
        background: linear-gradient(180deg, #5e5757 0%, #f0f4f8 100%);
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .factus-footer img {
        transition: transform 0.3s ease;
    }

    .factus-footer img:hover {
        transform: scale(1.1);
    }

    .factus-footer h3 {
        font-weight: 700;
        margin-bottom: 10px;
    }

    .factus-footer p {
        font-size: 1rem;
        max-width: 500px;
        margin: 0 auto;
    }
    /* Ajustar el formulario de logout */
    #logoutForm {
        margin: 5px 5px; /* Igual que los .nav-link para alineación */
    }
    /* Asegurar que el botón tenga el mismo estilo base */
    #logoutForm .btn-danger {
        padding: 12px; /* Igual que los .nav-link */
        font-weight: 500;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: flex-start; /* Alinear contenido a la izquierda */
        transition: background-color 0.2s ease;
    }
    #logoutForm .btn-danger i {
        margin-right: 10px; /* Igual que los íconos en .nav-link */
        font-size: 1.2rem;
    }

    /* Cuando la sidebar está colapsada */
    .sidebar.collapsed #logoutForm .btn-danger {
        justify-content: center;
        padding: 12px;
    }

    .sidebar.collapsed #logoutForm .btn-danger i {
        margin-right: 0;
    }

    /* Estilos para la información del usuario */
    .user-info {
        display: flex;
        align-items: center;
        padding: 10px 20px;
        margin: 10px 10px 20px 10px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        color: #e2e8f0;
    }

    .user-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
        border: 2px solid #ffffff;
    }

    .user-info span {
        font-weight: 500;
        font-size: 1rem;
    }

    /* Ajustar cuando la sidebar está colapsada */
    .sidebar.collapsed .user-info {
        flex-direction: column;
        padding: 10px;
        margin: 10px 5px 20px 5px;
    }

    .sidebar.collapsed .user-info img {
        margin-right: 0;
        margin-bottom: 5px;
    }

    .sidebar.collapsed .user-info span {
        display: none;
    }
    .swal-invoice-modal .swal2-popup {
        font-family: Arial, sans-serif;
        max-width: 95%;
        padding: 1rem;
    }

    .swal-invoice-modal .invoice-container {
        padding: 10px;
        font-size: 13px;
    }

    .swal-invoice-modal .card {
        border-radius: 6px;
        margin-bottom: 10px;
    }

    .swal-invoice-modal .card-header {
        padding: 6px 12px;
    }

    .swal-invoice-modal .card-body {
        padding: 10px;
    }

    /* More compact tables */
    .swal-invoice-modal .table {
        margin-bottom: 0;
        font-size: 12px;
    }

    .swal-invoice-modal .table th,
    .swal-invoice-modal .table td {
        padding: 6px 8px;
        vertical-align: middle;
    }

    /* Reduce spacing between sections */
    .swal-invoice-modal .row {
        margin-bottom: 10px;
    }

    /* Make badges more compact */
    .swal-invoice-modal .badge {
        font-size: 11px;
        padding: 3px 8px;
    }

    /* Compact footer */
    .swal-invoice-modal .invoice-footer {
        margin-top: 10px;
        padding-top: 5px;
        border-top: 1px solid #dee2e6;
        font-size: 11px;
    }

    /* Button styling for side-by-side layout */
    .swal-invoice-modal .swal2-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: nowrap;
    }

    .swal-invoice-modal .swal2-footer {
        margin-top: 0;
        padding-top: 8px;
        display: flex;
        justify-content: center;
    }

    /* Place buttons side by side */
    .swal-invoice-modal .btn {
        padding: 6px 10px;
        font-size: 13px;
        margin: 0 5px;
    }

    /* Remove excess spacing */
    .swal-invoice-modal .mb-4 {
        margin-bottom: 10px !important;
    }

    .swal-invoice-modal .mb-1 {
        margin-bottom: 3px !important;
    }
    /* Estilos específicos para ensanchar el modal de clientes */
    #clienteModal .modal-dialog {
        max-width: 700px; /* Aumentar el ancho desde el valor predeterminado */
        width: 90%; /* Asegurar que sea responsive en pantallas pequeñas */
        margin: 1.75rem auto; /* Mantener centrado */
    }

    /* Mejorar la distribución interna del modal */
    #clienteModal .modal-body {
        padding: 1.75rem;
    }



    /* Mantener consistencia con los estilos existentes */
    #clienteModal .modal-content {
        border-radius: 12px;
        border: none;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        overflow: hidden;
    }
    /* Estilos profesionales para el Modal de Factura Electrónica */

    /* Variables de colores corporativos */
    :root {
        --primary-color: #2c3e50;
        --secondary-color: #3498db;
        --accent-color: #1abc9c;
        --warning-color: #f39c12;
        --danger-color: #e74c3c;
        --light-color: #ecf0f1;
        --dark-color: #2c3e50;
        --text-color: #333333;
        --border-radius: 4px;
        --box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
    }

    /* Estilos generales del modal */
    #facturaModal .modal-content {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #facturaModal .modal-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        border-bottom: none;
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }

    #facturaModal .modal-footer {
        background-color: #f8f9fa;
        border-top: 1px solid #eaeaea;
        border-bottom-left-radius: var(--border-radius);
        border-bottom-right-radius: var(--border-radius);
    }

    /* Estilo para las tarjetas */
    #facturaModal .card {
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        border: 1px solid #eaeaea;
    }

    #facturaModal .card-header {
        font-weight: 600;
        border-bottom: 1px solid #eaeaea;
    }

    #facturaModal .card-header.bg-light {
        background: linear-gradient(to right, #f8f9fa, #ffffff);
    }

    #facturaModal .card-header.bg-dark {
        background: linear-gradient(to right, var(--primary-color), var(--dark-color));
    }

    /* Estilos para formularios */
    #facturaModal .form-control-sm,
    #facturaModal .form-select-sm {
        border: 1px solid #ced4da;
        border-radius: var(--border-radius);
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #facturaModal .form-control-sm:focus,
    #facturaModal .form-select-sm:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 0.15rem rgba(52, 152, 219, 0.25);
    }

    #facturaModal .form-control-sm:read-only {
        background-color: #f8f9fa;
        cursor: not-allowed;
    }

    #facturaModal .form-label {
        color: var(--text-color);
        font-weight: 500;
    }

    /* Estilos para los iconos */
    #facturaModal .fas {
        color: var(--secondary-color);
        margin-right: 4px;
    }

    #facturaModal .modal-header .fas,
    #facturaModal .card-header .fas {
        color: inherit;
    }

    /* Estilo para la tabla de productos */
    #facturaModal .table {
        margin-bottom: 0;
    }

    #facturaModal .table-dark {
        background: var(--primary-color);
    }

    #facturaModal .table th {
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 0.5px;
    }

    #facturaModal .table-responsive {
        border-radius: var(--border-radius);
        overflow: hidden;
    }

    /* Estilos para botones */
    #facturaModal .btn-sm {
        border-radius: var(--border-radius);
        font-weight: 500;
        padding: 0.25rem 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
    }

    #facturaModal .btn-info {
        background: linear-gradient(to right, var(--secondary-color), #2980b9);
        border: none;
    }

    #facturaModal .btn-secondary {
        background: linear-gradient(to right, #95a5a6, #7f8c8d);
        border: none;
    }

    #facturaModal .btn-success {
        background: linear-gradient(to right, var(--accent-color), #16a085);
        border: none;
    }

    #facturaModal .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    /* Estilo para campos de resumen */
    #facturaModal #factura-subtotal,
    #facturaModal #factura-iva-total,
    #facturaModal #factura-descuento-total,
    #facturaModal #factura-total {
        font-family: 'Roboto Mono', monospace, sans-serif;
        text-align: right;
    }

    #facturaModal #factura-total {
        color: var(--secondary-color);
        font-size: 0.95rem;
    }

    /* Estilo para la información del cliente */
    #facturaModal #cliente-nombres,
    #facturaModal #cliente-correos,
    #facturaModal #cliente-telefonos,
    #facturaModal #cliente-direcciones,
    #facturaModal #cliente-municipios {
        font-weight: 400;
        color: var(--text-color);
    }

    /* Estilo para información de estado */
    #facturaModal #factura-status {
        background-color: var(--warning-color);
        color: white;
        padding: 0.1rem 0.3rem;
        border-radius: 3px;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
    }



    /* Línea separadora del resumen */
    #facturaModal .summary-card hr {
        border-top: 1px dashed rgba(0, 0, 0, 0.1);
    }

    /* Estilos responsivos */
    @media (max-width: 992px) {
        #facturaModal .modal-dialog {
            max-width: 95%;
        }
    }

    /* Mejoras para detalles visuales */
    #facturaModal .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(236, 240, 241, 0.5);
    }

    /* Botón de acción para eliminar productos */
    #facturaModal .btn-eliminar-item {
        color: var(--danger-color);
        background: transparent;
        border: none;
        padding: 0;
        font-size: 0.85rem;
    }

    #facturaModal .btn-eliminar-item:hover {
        color: #c0392b;
    }

    /* Animaciones para mejorar la experiencia de usuario */
    #facturaModal.fade .modal-dialog {
        transition: transform 0.3s ease-out;
        transform: translateY(-20px);
    }

    #facturaModal.show .modal-dialog {
        transform: translateY(0);
    }

    /* Scroll personalizado para la tabla de productos */
    #facturaModal .table-responsive::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    #facturaModal .table-responsive::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    #facturaModal .table-responsive::-webkit-scrollbar-thumb {
        background: #bdc3c7;
        border-radius: 10px;
    }

    #facturaModal .table-responsive::-webkit-scrollbar-thumb:hover {
        background: #95a5a6;
    }
    /* Style the Select2 container to match the input */
    .select2-container--default .select2-selection--single {
        border: 1px solid #ced4da !important; /* Match border color of input */
        border-radius: 0.25rem !important;   /* Match border-radius of input */
        height: 45px !important;             /* Match height of form-control-sm */
        padding: 0.25rem 0.5rem !important;  /* Match padding of input */
        font-size: 0.875rem !important;      /* Match font size of input */
        line-height: 1.5 !important;         /* Match line height of input */
        background-color: #fff !important;   /* Match background color */
        box-shadow: none !important;         /* Remove any default shadow */
    }

    /* Style the placeholder text */
    .select2-container--default .select2-selection--single .select2-selection__placeholder {
        color: #6c757d !important;           /* Match placeholder color of input */
    }

    /* Style the selected text */
    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #495057 !important;           /* Match text color of input */
        line-height: 1.5 !important;         /* Align text vertically */
        padding-left: 0 !important;          /* Remove extra padding */
    }

    /* Style the dropdown arrow */
    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 30px !important;             /* Match height of container */
        width: 20px !important;              /* Adjust width of arrow area */
        right: 5px !important;               /* Position arrow */
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: #6c757d transparent transparent transparent !important; /* Match placeholder color */
        border-width: 5px 4px 0 4px !important; /* Smaller arrow */
        margin-top: -2px !important;         /* Center arrow vertically */
    }

    /* Focus state to match input */
    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #80bdff !important;    /* Match focus border color of input */
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25) !important; /* Match focus shadow */
        outline: none !important;
    }

    /* Style the dropdown menu */
    .select2-container--default .select2-dropdown {
        border: 1px solid #ced4da !important; /* Match border color */
        border-radius: 0.25rem !important;   /* Match border-radius */
        font-size: 0.875rem !important;      /* Match font size */
        margin-top: 0 !important;            /* No gap between input and dropdown */
    }

    .select2-container--default .select2-results__option {
        padding: 0.25rem 0.5rem !important;  /* Match padding */
        color: #495057 !important;           /* Match text color */
    }

    .select2-container--default .select2-results__option--highlighted[aria-selected] {
        background-color: #007bff !important; /* Match Bootstrap primary color */
        color: white !important;
    }
</style>

</head>
<body>

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-2 sidebar p-0">
            <div class="d-flex flex-column p-3">
                <!-- Logo y título -->
                <div class="text-center mb-4">
                    <img src="https://i.ibb.co/XkN8BLQ5/factus-logo.png" alt="Logo" width="40" class="mb-2">
                    <h4>FACTUS</h4>
                </div>
                <div class="user-info">
                    <!-- Mostrar la foto del usuario si existe, o la predeterminada si no -->
                    <img th:src="${userPicture != null && userPicture != ''} ? ${userPicture} : 'https://cdn-icons-png.flaticon.com/128/4526/4526169.png'" alt="Foto de perfil"/>
                    <!-- Mostrar el nombre del usuario -->
                    <span th:text="${userName != null} ? ${userName} : 'Usuario'">Usuario</span>
                </div>

                <!-- Menú de navegación -->
                <ul class="nav nav-pills flex-column mb-auto">
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link active" id="dashboard-link">
                            <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link" id="productos-link">
                            <i class="bi bi-cart-plus-fill"></i><span>Productos</span>
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link" id="clientes-link">
                            <i class="fas fa-users"></i> <span>Clientes</span>
                        </a>
                    </li>
                    <li class="nav-item mb-1">
                        <a href="#" class="nav-link" id="facturas-link">
                            <i class="fas fa-file-invoice-dollar"></i> <span>Facturas</span>
                        </a>
                    </li>
                </ul>

                <!-- Botón de logout -->
                <form id="logoutForm" class="mt-auto px-3" th:action="@{/logout}" method="post">
                    <button type="button" class="btn btn-danger btn-block w-100" onclick="confirmLogout()">
                        <i class="fas fa-sign-out-alt"></i> <span>Cerrar Sesión</span>
                    </button>
                </form>
            </div>

            <!-- Botón de la flecha -->
            <button class="sidebar-toggle btn btn-primary">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>

        <!-- Contenido principal -->
        <div class="col-md-10 content">
            <div id="dashboard-content" class="content-section">
                <center>  <h2 class="mb-4"> DASHBOARD </h2></center>
                <div class="row">
                    <div class="col-md-4 mb-4">
                        <div class="card bg-primary text-white clickable-card" data-section="clientes">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-users fa-2x me-3"></i>
                                <div>
                                    <h5 class="card-title">Clientes</h5>
                                    <p class="card-text h3 animated-number" id="total-clientes">0</p>


                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card bg-success text-white clickable-card" data-section="productos">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-box fa-2x me-3"></i>
                                <div>
                                    <h5 class="card-title">Productos</h5>
                                    <p class="card-text h3" id="total-productos">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card bg-info text-white clickable-card" data-section="facturas">
                            <div class="card-body d-flex align-items-center">
                                <i class="fas fa-file-invoice-dollar fa-2x me-3"></i>
                                <div>
                                    <h5 class="card-title">Facturas</h5>
                                    <p class="card-text h3" id="total-facturas">0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Logo de Factus debajo del dashboard -->
                <div class="factus-footer text-center mt-5">
                    <img src="https://i.ibb.co/XkN8BLQ5/factus-logo.png" alt="Factus Logo" class="img-fluid mb-3" style="max-width: 150px;">
                    <h3 class="text-primary">FACTUS</h3>
                    <p class="text-muted">Simplificando la gestión de tu negocio</p>
                </div>
            </div>
            <div id="productos-content" class="content-section" style="display:none;">
                <div class="header-section mb-6">
                    <h2 class="text-center">Gestión de Productos</h2>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productoModal">
                            <i class="fas fa-plus"></i> Nuevo Producto
                        </button>
                    </div>
                </div>
                <!-- Resto del contenido de productos (búsqueda, tabla, etc.) -->
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="buscar-productos" placeholder="Buscar producto por nombre o ID...">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Nombre</th>
                            <th scope="col">Precio</th>
                            <th scope="col">Unidad Medida</th>
                            <th scope="col">Tasa IVA</th>
                            <th scope="col">Código Estándar</th>
                            <th scope="col">Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="productos-table-body"></tbody>
                    </table>
                    <nav aria-label="Product pagination">
                        <ul class="pagination justify-content-center" id="productos-pagination"></ul>
                    </nav>
                </div>
            </div>

            <!-- Sección Clientes -->
            <div id="clientes-content" class="content-section" style="display:none;">
                <div class="header-section mb-6">
                    <h2 class="text-center">Gestión de Clientes</h2><div class="d-flex justify-content-end">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#clienteModal">
                        <i class="fas fa-plus"></i> Nuevo Cliente
                    </button>
                </div>
                </div>
                <!-- Campo de búsqueda -->
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="buscar-clientes" placeholder="Buscar cliente por nombre o identificación">
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Tipo de cliente</th>
                            <th>Identificación</th>
                            <th>Teléfono</th>
                            <th>Correo</th>
                            <th>Id legal</th>
                            <th>Id tributo</th>
                            <th>Iva</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody id="clientes-table-body">
                        <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                    <nav aria-label="Client pagination">
                        <ul class="pagination justify-content-center" id="clientes-pagination"></ul>
                    </nav>
                </div>
            </div>

            <!-- Sección Facturas -->
            <div id="facturas-content" class="content-section" style="display:none;">
                <div class="header-section mb-6">
                    <h2 class="text-center">Gestión de Facturas</h2>
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#facturaModal">
                            <i class="fas fa-plus"></i> Nueva Factura
                        </button>
                    </div>
                </div>

                <!-- Campo de búsqueda -->
                <div class="search-container">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="buscar-facturas" placeholder="Buscar factura por número o cliente...">
                    </div>
                </div>

                <div class="table-responsive">

                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>Número</th>
                            <th>Cliente</th>
                            <th>ID</th>
                            <th>Pago</th>
                            <th>Metodo</th>
                            <th>Creación factura</th>
                            <th>Estado</th>
                            <th>Fecha</th>
                            <th>Total</th>
                            <th>Acciones</th>


                        </tr>
                        </thead>
                        <tbody id="facturas-table-body">
                        <!-- Se llenará con JavaScript -->
                        </tbody>
                    </table>
                    <nav aria-label="Invoice pagination">
                        <ul class="pagination justify-content-center" id="facturas-pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Producto actualizado con los nuevos campos -->
<div class="modal fade" id="productoModal" tabindex="-1" aria-labelledby="productoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="productoModalLabel"><i class="fas fa-box"></i> Nuevo Producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="producto-form">
                    <input type="hidden" id="producto-id">
                    <input type="hidden" id="producto-standardCodeId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="producto-nombre" class="form-label">Nombre</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-tag"></i></span>
                                    <input type="text" class="form-control" id="producto-nombre" required>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="producto-precio" class="form-label">Precio</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-dollar-sign"></i></span>
                                    <input type="number" step="0.01" class="form-control" id="producto-precio" required>
                                </div>
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="producto-excluido">
                                <label class="form-check-label" for="producto-excluido">Excluido de impuestos</label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="producto-medida" class="form-label">Unidad de Medida</label>
                                <select class="form-select" id="producto-medida" required>
                                    <option value="70">Unidad</option>
                                    <option value="414">Kilogramo</option>
                                    <option value="449">Litro</option>
                                    <option value="512">Metro</option>
                                    <option value="874">Galon</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="producto-tasa-iva" class="form-label">Tasa IVA (%)</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-percent"></i></span>
                                    <input type="number" step="0.01" class="form-control" id="producto-tasa-iva" value="19">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Los campos de Código Estándar y Unidad de Medida se generarán automáticamente.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="guardar-producto">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cliente Actualizado -->
<div class="modal fade" id="clienteModal" tabindex="-1" aria-labelledby="clienteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="clienteModalLabel"><i class="fas fa-user"></i> Nuevo Cliente</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="cliente-form">
                    <input type="hidden" id="cliente-id">
                    <input type="hidden" id="cliente-legalOrganizationId">
                    <input type="hidden" id="cliente-tributeId">

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="cliente-tipo" class="form-label"><i class="fas fa-id-badge"></i> Tipo Cliente</label>
                            <select class="form-select" id="cliente-tipo" required>
                                <option value="Persona Natural">Persona Natural</option>
                                <option value="Persona Jurídica">Persona Jurídica</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-tipo-identificacion" class="form-label"><i class="fas fa-id-card"></i> Tipo Identificación</label>
                            <select class="form-select" id="cliente-tipo-identificacion" required>
                                <option value="Registro civil">Registro civil</option>
                                <option value="Tarjeta de identidad">Tarjeta de identidada</option>
                                <option value="Cédula ciudadanía">Cédula de Ciudadanía</option>
                                <option value="Cédula de extranjería">Cédula de extranjería</option>
                                <option value="NIT">NIT</option>
                                <option value="Pasaporte">Pasaporte</option>
                                <option value="Documento de identificación extranjero">Documento de identificación extranjero</option>
                                <option value="PEP">PEP</option>
                                <option value="NIT otro país">NIT otro país</option>
                                <option value="NUIP *">NUIP *</option>

                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-identificacion" class="form-label"><i class="fas fa-fingerprint"></i> Identificación</label>
                            <input type="text" class="form-control" id="cliente-identificacion" required>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="cliente-nombre" class="form-label"><i class="fas fa-user-tag"></i> Nombre</label>
                            <input type="text" class="form-control" id="cliente-nombre" required>
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-telefono" class="form-label"><i class="fas fa-phone"></i> Teléfono</label>
                            <input type="text" class="form-control" id="cliente-telefono">
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-correo" class="form-label"><i class="fas fa-envelope"></i> Correo</label>
                            <input type="email" class="form-control" id="cliente-correo">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="cliente-municipio" class="form-label"><i class="fas fa-city"></i> Municipio</label>
                            <input type="text" class="form-control" id="cliente-municipio" list="municipios-list" placeholder="Buscar municipio o departamento..." required>
                            <datalist id="municipios-list"></datalist>
                            <input type="hidden" id="cliente-municipio-id" name="municipio">
                        </div>

                        <div class="col-md-4">
                            <label for="cliente-direccion" class="form-label"><i class="fas fa-map-marker-alt"></i> Dirección</label>
                            <input type="text" class="form-control" id="cliente-direccion">
                        </div>
                        <div class="col-md-4">
                            <label for="cliente-aplica-iva" class="form-label"><i class="fas fa-receipt"></i> Aplica IVA</label>
                            <select class="form-select" id="cliente-aplica-iva" required>
                                <option value="Sí">Sí</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                    </div>

                    <!-- Campos específicos para Persona Jurídica -->
                    <div id="campos-juridica" style="display: none;">
                        <hr>
                        <center><h6 class="mb-3"><i class="bi bi-info-circle"></i> Información Comercial </h6></center>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="cliente-company" class="form-label"><i class="fas fa-building"></i> Razón Social</label>
                                <input type="text" class="form-control" id="cliente-company">
                            </div>
                            <div class="col-md-4">
                                <label for="cliente-tradeName" class="form-label"><i class="fas fa-store"></i> Nombre Comercial</label>
                                <input type="text" class="form-control" id="cliente-tradeName">
                            </div>
                            <div class="col-md-4">
                                <label for="cliente-verificationDigit" class="form-label"><i class="fas fa-check-circle"></i> Dígito de Verificación</label>
                                <input type="text" class="form-control" id="cliente-verificationDigit" maxlength="1">
                            </div>
                        </div>
                    </div>

                    <!-- Información sobre campos automáticos -->
                    <div class="alert alert-info mt-3">
                        <small><i class="fas fa-info-circle"></i> Los campos de ID Organización Legal y ID Tributo se generarán automáticamente según el tipo de cliente.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
                <button type="button" class="btn btn-success" id="guardar-cliente"><i class="fas fa-save"></i> Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Factura Electrónica Profesional -->
<div class="modal fade" id="facturaModal" tabindex="-1" aria-labelledby="facturaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header py-2">
                <h5 class="modal-title" id="facturaModalLabel"><i class="fas fa-file-invoice-dollar"></i> Nueva Factura Electrónica</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-2">
                <form id="factura-form">
                    <!-- Campos ocultos -->
                    <input type="hidden" id="factura-id">
                    <input type="hidden" id="factura-document" value="Factura electrónica de venta">
                    <input type="hidden" id="factura-numbering-range-id">
                    <input type="hidden" id="factura-reference-code">
                    <input type="hidden" id="factura-municipio-id">
                    <input type="hidden" id="factura-due-date">

                    <div class="row g-2">
                        <!-- Fila 1: Datos principales del cliente -->
                        <div class="col-md-8">
                            <div class="card mb-2">
                                <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 small"><i class="fas fa-user-check"></i> Información del Cliente</h6>
                                    <div class="badge bg-primary" id="factura-status">PENDIENTE</div>
                                </div>
                                <div class="card-body py-3 px-2">
                                    <div class="row g-1">
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-cliente" class="form-label small mb-0"><i class="fas fa-user-circle"></i> Cliente</label>
                                                <select class="form-select form-select-sm" id="factura-cliente" name="factura-cliente" required>
                                                    <option value="">Buscar cliente por nombre o identificación </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-identification" class="form-label small mb-0"><i class="fas fa-id-card"></i> Identificación</label>
                                                <input type="text" class="form-control form-control-sm" id="factura-identification" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-1 mt-1">
                                        <div class="col-md-4">
                                            <p class="mb-0 small"><i class="fas fa-user"></i> <strong>Nombre:</strong> <span id="cliente-nombres">-</span></p>
                                            <p class="mb-0 small"><i class="fas fa-tag"></i> <strong>Tipo:</strong> <span id="cliente-tipos">-</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-0 small"><i class="fas fa-envelope"></i> <strong>Correo:</strong> <span id="cliente-correos">-</span></p>
                                            <p class="mb-0 small"><i class="fas fa-phone"></i> <strong>Teléfono:</strong> <span id="cliente-telefonos">-</span></p>
                                        </div>
                                        <div class="col-md-4">
                                            <p class="mb-0 small"><i class="fas fa-map-marker-alt"></i> <strong>Dirección:</strong> <span id="cliente-direcciones">-</span></p>
                                            <p class="mb-0 small"><i class="fas fa-city"></i> <strong>Municipio:</strong> <span id="cliente-municipios">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 1 (derecha): Datos de la factura -->
                        <div class="col-md-4">
                            <div class="card mb-2">
                                <div class="card-header py-1 px-2">
                                    <h6 class="mb-0 small"><i class="fas fa-file-alt"></i> Datos del Documento</h6>
                                </div>
                                <div class="card-body py-1 px-2">
                                    <div class="row g-1">
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-fecha" class="form-label small mb-0"><i class="fas fa-calendar-alt"></i> Fecha</label>
                                                <input type="date" class="form-control form-control-sm" id="factura-fecha" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-document-name" class="form-label small mb-0"><i class="fas fa-file"></i> Nombre</label>
                                                <input type="text" class="form-control form-control-sm" id="factura-document-name" value="Factus">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row g-1">
                                        <div class="col-12">
                                            <p class="mb-0 small"><i class="fas fa-hashtag"></i> <strong>Número:</strong> <span id="factura-numero" class="badge bg-secondary">-</span></p>
                                            <p class="mb-0 small"><i class="fas fa-barcode"></i> <strong>Código Ref:</strong> <span id="factura-reference-code-display" class="small text-muted">-</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 2: Método de pago -->
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-header py-1 px-2">
                                    <h6 class="mb-0 small"><i class="fas fa-credit-card"></i> Condiciones de Pago</h6>
                                </div>
                                <div class="card-body py-1 px-2">
                                    <div class="row g-1">
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-forma-pago" class="form-label small mb-0"><i class="fas fa-money-check"></i> Forma de Pago</label>
                                                <select class="form-select form-select-sm" id="factura-forma-pago" required>
                                                    <option value="Contado">Contado</option>
                                                    <option value="Crédito">Crédito</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-metodo-pago" class="form-label small mb-0"><i class="fas fa-credit-card"></i> Método de Pago</label>
                                                <select class="form-select form-select-sm" id="factura-metodo-pago" required>
                                                    <option value="Efectivo">Efectivo</option>
                                                    <option value="Cheque">Cheque</option>
                                                    <option value="Transferencia">Transferencia</option>
                                                    <option value="Tarjeta Crédito">Tarjeta Crédito</option>
                                                    <option value="Tarjeta Débito">Tarjeta Débito</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 2 (derecha): Campos adicionales -->
                        <div class="col-md-6">
                            <div class="card mb-2">
                                <div class="card-header py-1 px-2">
                                    <h6 class="mb-0 small"><i class="fas fa-info-circle"></i> Información Adicional</h6>
                                </div>
                                <div class="card-body py-1 px-2">
                                    <div class="row g-1">
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-api-client-name" class="form-label small mb-0"><i class="fas fa-user-tag"></i> API Cliente</label>
                                                <input type="text" class="form-control form-control-sm" id="factura-api-client-name" readonly>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-group mb-1">
                                                <label for="factura-graphic-representation" class="form-label small mb-0"><i class="fas fa-file-image"></i> Representación</label>
                                                <input type="text" class="form-control form-control-sm" id="factura-graphic-representation" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 3: Productos con tabla compacta -->
                        <div class="col-md-8">
                            <div class="card mb-2">
                                <div class="card-header py-1 px-2 d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 small"><i class="fas fa-shopping-cart"></i> Productos</h6>
                                    <button type="button" class="btn btn-success btn-sm py-0" id="agregar-item">
                                        <i class="fas fa-plus"></i> Agregar Producto
                                    </button>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive" style="max-height: 150px; overflow-y: auto;">
                                        <table class="table table-sm table-striped mb-0">
                                            <thead class="table-dark">
                                            <tr>
                                                <th class="small">Producto</th>
                                                <th class="small">Unidad </th>
                                                <th class="small">Precio</th>
                                                <th class="small">Descu%</th>
                                                <th class="small">Subtotal</th>
                                                <th class="small">IVA</th>
                                                <th class="small">Total</th>
                                                <th class="small text-center">Del</th>
                                            </tr>
                                            </thead>
                                            <tbody id="factura-items"></tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer py-1 px-2 text-muted">
                                    <small><i class="fas fa-info-circle"></i> Líneas: <span id="factura-lines-count">0</span></small>
                                </div>
                            </div>
                        </div>

                        <!-- Fila 3 (derecha): Observación y Resumen -->
                        <div class="col-md-4">
                            <div class="card mb-2">
                                <div class="card-header py-1 px-2">
                                    <h6 class="mb-0 small"><i class="fas fa-comment"></i> Observación</h6>
                                </div>
                                <div class="card-body py-1 px-2">
                                    <textarea class="form-control form-control-sm" id="factura-observation" rows="2" placeholder="Cliente capacitado"></textarea>
                                </div>
                            </div>

                            <div class="card summary-card">
                                <div class="card-header bg-dark text-white py-1 px-2">
                                    <h6 class="mb-0 small"><i class="fas fa-calculator"></i> Resumen</h6>
                                </div>
                                <div class="card-body py-1 px-2">
                                    <div class="d-flex justify-content-between mb-0">
                                        <span class="small">Subtotal:</span>
                                        <span id="factura-subtotal" class="small">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-0">
                                        <span class="small">IVA:</span>
                                        <span id="factura-iva-total" class="small">$0.00</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-0">
                                        <span class="small">Descuento:</span>
                                        <span id="factura-descuento-total" class="small">$0.00</span>
                                    </div>
                                    <hr class="my-1">
                                    <div class="d-flex justify-content-between">
                                        <strong class="small">TOTAL:</strong>
                                        <strong id="factura-total" class="small">$0.00</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer py-2">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cancelar</button>
                <button type="button" class="btn btn-info btn-sm text-white" id="guardar-factura"><i class="fas fa-save"></i> Guardar Factura</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal Selección de Productos -->
<div class="modal fade" id="seleccionarProductoModal" tabindex="-1" aria-labelledby="seleccionarProductoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="seleccionarProductoModalLabel"><i class="fas fa-boxes"></i> Seleccionar Producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="filter-container mb-2">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control" id="buscar-producto" placeholder="Buscar por nombre o código">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead class="table-dark">
                        <tr>
                            <th>Código</th>
                            <th>Nombre</th>
                            <th>Precio</th>
                            <th>IVA %</th>
                            <th>Acción</th>
                        </tr>
                        </thead>
                        <tbody id="seleccionar-producto-body"></tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <span id="productos-total">0 productos</span>
                    <nav>
                        <ul class="pagination pagination-sm" id="producto-pagination"></ul>
                    </nav>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmar Eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar este elemento? Esta acción no se puede deshacer.</p>
                <input type="hidden" id="delete-type">
                <input type="hidden" id="delete-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-danger" id="confirmar-eliminacion">Eliminar</button>
            </div>
        </div>
    </div>
</div>
<!-- Scripts de Bootstrap y jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>

    document.addEventListener('DOMContentLoaded', function() {
        let municipiosData = [];

        async function loadMunicipios(searchTerm = '') {
            try {
                const response = await fetch('/json/municipios.json');
                if (!response.ok) throw new Error('Error al cargar municipios');
                const data = await response.json();
                municipiosData = data.data;
                const datalist = document.getElementById('municipios-list');
                datalist.innerHTML = '';

                const filteredMunicipios = searchTerm
                    ? municipiosData.filter(m =>
                        m.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        m.department.toLowerCase().includes(searchTerm.toLowerCase())
                    )
                    : municipiosData;

                filteredMunicipios.slice(0, 50).forEach(m => {
                    const option = document.createElement('option');
                    option.value = `${m.name} (${m.department})`;
                    option.dataset.id = m.id;
                    datalist.appendChild(option);
                });

                if (filteredMunicipios.length === 0) {
                    const option = document.createElement('option');
                    option.value = 'No se encontraron municipios';
                    option.disabled = true;
                    datalist.appendChild(option);
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar los municipios'
                });
            }
        }

        const municipioInput = document.getElementById('cliente-municipio');
        const municipioIdInput = document.getElementById('cliente-municipio-id');
        municipioInput.addEventListener('input', function() {
            const searchTerm = this.value;
            loadMunicipios(searchTerm);

            const selectedOption = Array.from(document.getElementById('municipios-list').options).find(
                option => option.value === this.value && option.dataset.id
            );
            municipioIdInput.value = selectedOption ? selectedOption.dataset.id : '';
        });

        document.getElementById('clienteModal').addEventListener('show.bs.modal', async function(e) {
            await loadMunicipios();
            const form = document.getElementById('cliente-form');
            const municipioInput = document.getElementById('cliente-municipio');
            const municipioIdInput = document.getElementById('cliente-municipio-id');

            if (!e.relatedTarget.classList.contains('edit-cliente')) {
                document.getElementById('clienteModalLabel').textContent = 'Nuevo Cliente';
                form.reset();
                document.getElementById('cliente-id').value = '';
                document.getElementById('campos-juridica').style.display = 'none';
                municipioInput.value = '';
                municipioIdInput.value = '';
            } else {
                const id = e.relatedTarget.dataset.id;
                try {
                    const response = await fetch(`/api/clientes/${id}`);
                    if (!response.ok) throw new Error('Error al cargar cliente');
                    const cliente = await response.json();
                    if (cliente.municipio) {
                        municipioInput.value = `${cliente.municipio.name} (${cliente.municipio.department})`;
                        municipioIdInput.value = cliente.municipio.id;
                        const datalist = document.getElementById('municipios-list');
                        datalist.innerHTML = '';
                        const option = document.createElement('option');
                        option.value = municipioInput.value;
                        option.dataset.id = cliente.municipio.id;
                        datalist.appendChild(option);
                    }
                } catch (error) {
                    console.error('Error al cargar cliente:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar el municipio del cliente'
                    });
                }
            }
        });

        document.getElementById('cliente-tipo').addEventListener('change', function() {
            const camposJuridica = document.getElementById('campos-juridica');
            if (this.value === 'Persona Jurídica') {
                camposJuridica.style.display = 'block';
                document.getElementById('cliente-tipo-identificacion').value = 'NIT';
            } else {
                camposJuridica.style.display = 'none';
            }
        });
    });

    // Script para ajustar posición de dropdowns en tablas
    document.addEventListener('shown.bs.dropdown', function(event) {
        const dropdown = event.target;

        // Si el dropdown está dentro de una tabla
        if (dropdown.closest('.table')) {
            const menu = dropdown.querySelector('.dropdown-menu');
            const buttonRect = dropdown.getBoundingClientRect();

            // Calcular posición ideal
            const left = buttonRect.left;
            let top = buttonRect.bottom + 2; // 2px de separación (reducido)

            // Verificar si hay espacio hacia abajo
            const viewportHeight = window.innerHeight;
            const menuHeight = menu.offsetHeight;

            if (top + menuHeight > viewportHeight) {
                // No hay espacio abajo, mostrar arriba
                top = buttonRect.top - menuHeight - 2;
            }

            // Aplicar posición manualmente
            menu.style.position = 'fixed';
            menu.style.top = `${top}px`;
            menu.style.left = `${left}px`;
            menu.style.zIndex = '1000';
            menu.style.width = 'auto';
            menu.style.minWidth = '40px';
            menu.style.boxShadow = '0 3px 6px rgba(0,0,0,0.16)';
        }
    });;

    document.querySelectorAll('.dropdown-toggle').forEach(button => {
        button.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            const dropdownMenu = button.nextElementSibling;
            const isVisible = dropdownMenu.style.display === 'block';

            // Cerrar todos los dropdowns primero
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });

            // Mostrar/ocultar el dropdown actual
            if (!isVisible) {
                dropdownMenu.style.display = 'block';

                // Ajustar posición si está cerca del borde
                const rect = dropdownMenu.getBoundingClientRect();
                if (rect.right > window.innerWidth) {
                    dropdownMenu.style.left = 'auto';
                    dropdownMenu.style.right = '0';
                }
                if (rect.bottom > window.innerHeight) {
                    dropdownMenu.style.top = 'auto';
                    dropdownMenu.style.bottom = '100%';
                }
            }
        });
    });

    // Cerrar dropdowns al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-menu').forEach(menu => {
                menu.style.display = 'none';
            });
        }
    });

    $(document).ready(function() {

        // Manejar el botón de la flecha para abrir/cerrar sidebar
        $('.sidebar-toggle').click(function() {
            $('.sidebar').toggleClass('collapsed');
            $('.content').toggleClass('collapsed');
        });

        // Manejar clics en las tarjetas del dashboard
        $('.clickable-card').click(function() {
            const section = $(this).data('section');
            $('.nav-link').removeClass('active');
            $('.content-section').hide();
            $('#buscar-productos, #buscar-clientes, #buscar-facturas').val('');

            if (section === 'productos') {
                $('#productos-link').addClass('active');
                $('#productos-content').show();
                loadProductos(1);
            } else if (section === 'clientes') {
                $('#clientes-link').addClass('active');
                $('#clientes-content').show();
                loadClientes(1);
            } else if (section === 'facturas') {
                $('#facturas-link').addClass('active');
                $('#facturas-content').show();
                loadFacturas(1);
            }
        });
// Buscador para Productos
        $('#buscar-productos').on('keyup', function() {
            loadProductos(1);
            const searchTerm = $(this).val().toLowerCase();
            $('#productos-table-body tr').each(function() {
                const id = $(this).find('td:eq(0)').text().toLowerCase();
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                if (id.includes(searchTerm) || nombre.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

// Buscador para Clientes
        $('#buscar-clientes').on('keyup', function() {
            loadClientes(1);
            const searchTerm = $(this).val().toLowerCase();
            $('#clientes-table-body tr').each(function() {
                const id = $(this).find('td:eq(0)').text().toLowerCase();
                const nombre = $(this).find('td:eq(1)').text().toLowerCase();
                const identificacion = $(this).find('td:eq(3)').text().toLowerCase();
                if (id.includes(searchTerm) || nombre.includes(searchTerm) || identificacion.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

// Buscador para Facturas
        $('#buscar-facturas').on('keyup', function() {
            loadFacturas(1);
            const searchTerm = $(this).val().toLowerCase();
            $('#facturas-table-body tr').each(function() {
                const numero = $(this).find('td:eq(0)').text().toLowerCase();
                const cliente = $(this).find('td:eq(1)').text().toLowerCase();
                if (numero.includes(searchTerm) || cliente.includes(searchTerm)) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });

        $('#dashboard-link, #productos-link, #clientes-link, #facturas-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();

            $('#buscar-productos, #buscar-clientes, #buscar-facturas').val('');

            if ($(this).is('#dashboard-link')) {
                $('#dashboard-content').show();
                loadDashboardStats();
            } else if ($(this).is('#productos-link')) {
                $('#productos-content').show();
                loadProductos(1); // Siempre inicia en página 1
            } else if ($(this).is('#clientes-link')) {
                $('#clientes-content').show();
                loadClientes(1); // Siempre inicia en página 1
            } else if ($(this).is('#facturas-link')) {
                $('#facturas-content').show();
                loadFacturas(1); // Siempre inicia en página 1
            }
        });


        // Navegación
        $('#dashboard-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#dashboard-content').show();
            loadDashboardStats();
        });

        $('#productos-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#productos-content').show();
            loadProductos();
        });

        $('#clientes-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#clientes-content').show();
            loadClientes();
        });

        $('#facturas-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();
            $('#facturas-content').show();
            loadFacturas();
        });

        // Confirmar logout
        window.confirmLogout = function() {
            Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Quieres cerrar sesión?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, cerrar sesión',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    document.getElementById("logoutForm").submit();
                }
            });
        };

        // Funciones de carga de datos
        function loadDashboardStats() {
            $.ajax({
                url: '/api/clientes',
                method: 'GET',
                success: function(data) {
                    $('#total-clientes').text(data.length);
                }
            });


            $.ajax({
                url: '/api/productos',
                method: 'GET',
                success: function(data) {
                    $('#total-productos').text(data.length);
                }
            });

            $.ajax({
                url: '/api/facturas/listar',
                method: 'GET',
                success: function(data) {
                    $('#total-facturas').text(data.length);
                }
            });
        }

        function renderPagination(totalPages, currentPage, section) {
            console.log(`Renderizando paginación para ${section}: Total páginas = ${totalPages}, Página actual = ${currentPage}`);
            const paginationUl = $(`#${section}-pagination`);
            paginationUl.empty();

            if (totalPages <= 1) {
                console.log('No se necesita paginación (1 página o menos)');
                return;
            }

            const maxPagesToShow = 3;
            let startPage = Math.max(1, currentPage - 1);
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // Previous button
            paginationUl.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">
                <i class="fas fa-chevron-left"></i>
            </a>
        </li>
    `);

            // First page
            if (startPage > 1) {
                paginationUl.append(`
            <li class="page-item ${currentPage === 1 ? 'active' : ''}">
                <a class="page-link" href="#" data-page="1">1</a>
            </li>
        `);
                if (startPage > 2) {
                    paginationUl.append(`
                <li class="page-item disabled">
                    <a class="page-link" href="#">...</a>
                </li>
            `);
                }
            }

            // Pages
            for (let i = startPage; i <= endPage; i++) {
                paginationUl.append(`
            <li class="page-item ${currentPage === i ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
            }

            // Last page and ellipsis
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationUl.append(`
                <li class="page-item disabled">
                    <a class="page-link" href="#">...</a>
                </li>
            `);
                }
                paginationUl.append(`
            <li class="page-item ${currentPage === totalPages ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>
            </li>
        `);
            }

            // Next button
            paginationUl.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">
                <i class="fas fa-chevron-right"></i>
            </a>
        </li>
    `);

            // Add click event based on section
            $(`#${section}-pagination .page-link`).click(function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && !$(this).parent().hasClass('disabled') && !$(this).parent().hasClass('active')) {
                    if (section === 'productos') {
                        loadProductos(page);
                    } else if (section === 'clientes') {
                        loadClientes(page);
                    } else if (section === 'facturas') {
                        loadFacturas(page);
                    }
                }
            });
        }



        function loadClientes(page = 1, itemsPerPage = 9) {
            $.ajax({
                url: '/api/clientes',
                method: 'GET',
                success: function(data) {
                    // Ordenar clientes por ID descendente (los más nuevos primero)
                    data.sort((a, b) => b.id - a.id);
                    const tbody = $('#clientes-table-body');
                    tbody.empty();

                    const searchTerm = $('#buscar-clientes').val().toLowerCase();
                    const filteredData = data.filter(cliente =>
                        cliente.id.toString().includes(searchTerm) ||
                        cliente.nombre.toLowerCase().includes(searchTerm) ||
                        cliente.identificacion.toLowerCase().includes(searchTerm)
                    );

                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const currentPage = Math.min(Math.max(1, page), totalPages);
                    const paginatedData = filteredData.slice(startIndex, endIndex);

                    paginatedData.forEach(function(cliente) {
                        tbody.append(`
                        <tr>
                            <td>${cliente.id}</td>
                            <td>${cliente.nombre}</td>
                            <td>${cliente.tipoCliente}</td>
                            <td>${cliente.identificacion}</td>
                            <td>${cliente.telefono || 'N/A'}</td>
                            <td>${cliente.correo || 'N/A'}</td>
                            <td>${cliente.legalOrganizationId || 'N/A'}</td>
                            <td>${cliente.tributeId || 'N/A'}</td>
                            <td>${cliente.aplicaIVA || 'No'}</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn btn-sm btn-primary edit-cliente" data-id="${cliente.id}" data-bs-toggle="tooltip" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger delete-cliente" data-id="${cliente.id}" data-bs-toggle="tooltip" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                    });

                    if (paginatedData.length === 0) {
                        tbody.append(`
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-users"></i>
                                <h4>No hay clientes</h4>
                                <p>No se encontraron clientes que coincidan con la búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `);
                    }

                    renderPagination(totalPages, currentPage, 'clientes');

                    $('.edit-cliente').click(function() {
                        const id = $(this).data('id');
                        editCliente(id);
                    });

                    $('.delete-cliente').click(function() {
                        const id = $(this).data('id');
                        openDeleteModal('cliente', id);
                    });
                }
            });
        }

        $('#buscar-clientes').on('keyup', function() {
            loadClientes(1);
        });
        function loadFacturas(page = 1, itemsPerPage = 9) {
            $.ajax({
                url: '/api/facturas/listar',
                method: 'GET',
                success: function(data) {
                    // Ordenar facturas por fecha descendente (las más nuevas primero)
                    data.sort((a, b) => {
                        // Si ambas tienen fecha, comparar por fecha
                        if (a.createdAt && b.createdAt) {
                            return new Date(b.createdAt) - new Date(a.createdAt);
                        }
                        // Si no, comparar por ID descendente
                        return b.id - a.id;
                    });

                    const tbody = $('#facturas-table-body');
                    tbody.empty();

                    const searchTerm = $('#buscar-facturas').val().toLowerCase();
                    const filteredData = data.filter(factura =>
                        factura.numero?.toLowerCase().includes(searchTerm) ||
                        factura.cliente?.nombre.toLowerCase().includes(searchTerm)
                    );

                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const currentPage = Math.min(Math.max(1, page), totalPages);
                    const paginatedData = filteredData.slice(startIndex, endIndex);

                    paginatedData.forEach(function(factura) {
                        const clienteNombre = factura.cliente ? factura.cliente.nombre : 'N/A';
                        const fecha = factura.createdAt ? new Date(factura.createdAt).toLocaleDateString() : 'N/A';
                        const hasCliente = factura.cliente && factura.cliente.nombre;

                        // Convertir factura.cliente a JSON y escapar las comillas
                        let clienteData;
                        try {
                            clienteData = factura.cliente ? JSON.stringify(factura.cliente).replace(/'/g, "\\'") : '{}';
                        } catch (error) {
                            console.error("Error al convertir cliente a JSON:", error);
                            clienteData = '{}'; // Valor por defecto si falla
                        }

                        // Obtener el CUFE de la factura (ajusta el nombre del campo según tu API)
                        const cufe = factura.cufe || ''; // Usa 'cierto' como fallback si no hay CUFE
                        const dianUrl = `https://catalogo-vpfe-hab.dian.gov.co/User/SearchDocument?DocumentKey=${encodeURIComponent(cufe)}`;

                        tbody.append(`
                    <tr>
                        <td>${factura.numero || 'N/A'}</td>
                        <td>${clienteNombre}</td>
                        <td>${factura.identificacion || 'N/A'}</td>
                        <td>${factura.pagos || 'N/A'}</td>
                        <td>${factura.metodopago || 'N/A'}</td>
                        <td>${factura.createdAt || 'N/A'}</td>
                        <td>${factura.status || 'N/A'}</td>
                        <td>${fecha}</td>
                        <td>$${factura.total?.toFixed(2) || '0.00'}</td>
                        <td>
                            <div class="dropdown position-static">
                                <button class="btn btn-sm btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-cog"></i> Opciones
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" data-bs-popper="static">
                                    <li>
                                        <a class="dropdown-item edit-factura" href="#" data-id="${factura.id}">
                                            <i class="fas fa-edit"></i> Editar
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item view-factura" href="#" data-id="${factura.id}" data-numero="${factura.numero || 'N/A'}" data-cliente='${clienteData}' ${hasCliente ? '' : 'style="pointer-events: none; opacity: 0.5;" title="No hay cliente asociado"'}>
                                            <i class="fas fa-eye"></i> Detalles
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item download-factura" href="#" data-id="${factura.numero}">
                                            <i class="fas fa-download"></i> Pdf
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item validate-factura-btn" href="#" data-id="${factura.numero}">
                                            <i class="bi bi-check-circle"></i> Validar
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item download-xml-btn" href="#" data-id="${factura.numero}">
                                            <i class="bi bi-file-earmark-code"></i> XML
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item dian-redirect" href="#" data-url="${dianUrl}">
                                            <i class="fas fa-globe"></i> DIAN
                                        </a>
                                    </li>
                                    <li class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item delete-factura-btn text-danger" href="#" data-id="${factura.referenceCode || 'N/A'}">
                                            <i class="bi bi-trash"></i> Eliminar
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                `);
                    });

                    if (paginatedData.length === 0) {
                        tbody.append(`
                    <tr>
                        <td colspan="10" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-file-invoice-dollar"></i>
                                <h4>No hay facturas</h4>
                                <p>No se encontraron facturas que coincidan con la búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `);
                    }

                    renderPagination(totalPages, currentPage, 'facturas');

                    // Reasignar eventos para las acciones del menú desplegable
                    $('.edit-factura').click(function(e) {
                        e.preventDefault();
                        const id = $(this).data('id');
                        editFactura(id);
                    });

                    $(document).on('click', '.view-factura', function(e) {
                        e.preventDefault();
                        const id = $(this).data('id');
                        const numero = $(this).data('numero');
                        let cliente = null;

                        // Obtener el valor exacto del atributo data-cliente
                        const clienteRaw = $(this).attr('data-cliente');
                        if (clienteRaw && clienteRaw !== '{}') {
                            try {
                                cliente = JSON.parse(clienteRaw);
                            } catch (error) {
                                console.error("Error al parsear cliente:", error, "Valor recibido:", clienteRaw);
                                cliente = null; // Si falla el parseo, cliente será null
                            }
                        }

                        viewFactura(id, numero, cliente);
                    });

                    $('.download-factura').click(function(e) {
                        e.preventDefault();
                        const number = $(this).data('id');
                        descargarFactura(number);
                    });

                    $('.validate-factura-btn').click(function(e) {
                        e.preventDefault();
                        const number = $(this).data('id');
                        validateFactura(number);
                    });

                    $('.download-xml-btn').click(function(e) {
                        e.preventDefault();
                        const number = $(this).data('id');
                        descargarXml(number);
                    });

                    $('.delete-factura-btn').click(function(e) {
                        e.preventDefault();
                        const referenceCode = $(this).data('id');
                        eliminarFactura(referenceCode);
                    });

                    // Evento para el botón DIAN
                    $('.dian-redirect').click(function(e) {
                        e.preventDefault();
                        const url = $(this).data('url');

                        // Mostrar modal con el código QR
                        Swal.fire({
                            title: 'Código QR para DIAN',
                            html: `
                        <div style="text-align: center;">
                            <p>Escanea el código QR para verificar en la DIAN</p>
                            <img src="https://i.ibb.co/5x1HysZ9/image.png" alt="Código QR" style="width: 200px; height: 200px; margin: 10px 0;" />
                        </div>
                    `,
                            showCancelButton: true,
                            confirmButtonText: 'Ir a la DIAN',
                            cancelButtonText: 'Cancelar',
                            confirmButtonColor: '#3085d6',
                            cancelButtonColor: '#d33',
                            width: '400px',
                            didRender: () => {
                                const qrImage = Swal.getHtmlContainer().querySelector('img');
                                qrImage.style.display = 'block';
                                qrImage.style.margin = '0 auto';
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.open(url, '_blank');
                            }
                        });
                    });
                },
                error: function(xhr, status, error) {
                    console.error("Error cargando facturas:", error);
                    $('#facturas-table-body').html('<tr><td colspan="10" class="text-center text-danger">Error al cargar facturas</td></tr>');
                }
            });
        }
        $('#buscar-facturas').on('keyup', function() {
            loadFacturas(1);
        });

        $('#dashboard-link, #productos-link, #clientes-link, #facturas-link').click(function(e) {
            e.preventDefault();
            $('.nav-link').removeClass('active');
            $(this).addClass('active');
            $('.content-section').hide();

            $('#buscar-productos, #buscar-clientes, #buscar-facturas').val('');

            if ($(this).is('#dashboard-link')) {
                $('#dashboard-content').show();
                loadDashboardStats();
            } else if ($(this).is('#productos-link')) {
                $('#productos-content').show();
                loadProductos(1); // Siempre inicia en página 1
            } else if ($(this).is('#clientes-link')) {
                $('#clientes-content').show();
                loadClientes(1); // Siempre inicia en página 1
            } else if ($(this).is('#facturas-link')) {
                $('#facturas-content').show();
                loadFacturas(1); // Siempre inicia en página 1
            }
        });


        function viewFactura(id, facturaNumero, cliente) {
            console.log("Visualizando factura ID:", id);
            console.log("Número de factura recibido:", facturaNumero);
            console.log("Cliente recibido:", cliente);

            Swal.fire({
                title: 'Cargando detalles',
                text: 'Espere por favor...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            $.ajax({
                url: `/api/facturas/ver/${id}`,
                method: 'GET',
                success: function(data) {
                    Swal.close();

                    if (data.error) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: data.error,
                            confirmButtonColor: '#3085d6'
                        });
                        return;
                    }

                    // Asignar el número de factura
                    data.numero = facturaNumero !== 'N/A' ? facturaNumero : id;

                    // Validar que cliente sea un objeto válido con al menos un nombre
                    data.cliente = cliente && typeof cliente === 'object' && cliente.nombre ? cliente : null;

                    let currentDate = new Date().toLocaleDateString('es-ES');
                    let modalContent = `
                <div class="invoice-container">
                    <!-- Encabezado de la factura -->
                    <div class="invoice-header">
                        <div class="row align-items-center mb-4">
                            <div class="col-md-6">
                                <div class="company-logo">
                                    <h2 class="mb-1">REREFENCIA</h2>
                                    <div class="text-muted">N FROM ° ${data.referenceCode}</div>
                                </div>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <div class="invoice-date">
                                    <div class="date-label">Fecha de emisión:</div>
                                    <div class="date-value">${data.fecha || currentDate}</div>
                                </div>
                            </div>
                        </div>
                        <hr class="separator">
                    </div>

                    <!-- Información del cliente y empresa -->
                    <div class="row invoice-info mb-4">
                        <div class="col-md-6">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Cliente</h5>
                                </div>
                                <div class="card-body">
                                    ${data.cliente ? `
                                    <div class="client-details">
                                        <p class="mb-1"><strong>${data.cliente.nombre || 'N/A'}</strong></p>
                                        <p class="mb-1"><i class="fas fa-id-card me-2"></i>${data.cliente.ids || data.cliente.identificacion || 'N/A'}</p>
                                        <p class="mb-1"><i class="fas fa-envelope me-2"></i>${data.cliente.email || data.cliente.correo || 'N/A'}</p>
                                        <p class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>${data.cliente.address || data.cliente.direccion || 'N/A'}</p>
                                    </div>
                                    ` : 'No hay información del cliente disponible'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card shadow-sm h-100">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Detalles de Factura</h5>
                                </div>
                                <div class="card-body">
                                    <p class="mb-1"><strong>Factura:</strong> #${data.numero}</p>
                                    <p class="mb-1"><strong>Fecha:</strong> ${data.createdAt || currentDate}</p>
                                    <p class="mb-1"><strong>Estado:</strong> <span class="badge bg-success">${data.status || 'Emitida'}</span></p>
                                    <p class="mb-0"><strong>Método de pago:</strong> ${data.metodoPago || 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Detalle de productos -->
                    <div class="items-section mb-4">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">Detalle de Productos</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th class="text-start">Producto</th>
                                                <th class="text-center">Cantidad</th>
                                                <th class="text-end">Precio</th>
                                                <th class="text-end">IVA</th>
                                                <th class="text-end">Dto %</th>
                                                <th class="text-end">Subtotal</th>
                                                <th class="text-end">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>`;

                    if (data.items && data.items.length > 0) {
                        data.items.forEach(item => {
                            modalContent += `
                        <tr>
                            <td class="text-start">${item.producto || 'N/A'}</td>
                            <td class="text-center">${item.cantidad || '0'}</td>
                            <td class="text-end">$${item.precio ? item.precio.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0'}</td>
                            <td class="text-end">$${item.iva ? item.iva.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0'}</td>
                            <td class="text-end">${item.porcentajeDescuento ? item.porcentajeDescuento.toFixed(1) : '0.0'}%</td>
                            <td class="text-end">$${item.subtotal ? item.subtotal.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0'}</td>
                            <td class="text-end">$${item.total ? item.total.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0'}</td>
                        </tr>`;
                        });
                    } else {
                        modalContent += `<tr><td colspan="7" class="text-center">No hay items disponibles</td></tr>`;
                    }

                    modalContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Resumen de totales -->
                    <div class="row">
                        <div class="col-md-5 ms-auto">
                            <div class="card shadow-sm">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Resumen</h5>
                                </div>
                                <div class="card-body p-0">
                                    <table class="table table-sm mb-0">
                                        <tbody>`;

                    if (data.totals) {
                        modalContent += `
                                            <tr>
                                                <td class="text-start"><strong>Subtotal</strong></td>
                                                <td class="text-end">$${data.totals.grossTotal ? data.totals.grossTotal.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0.00'}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-start"><strong>Descuentos</strong></td>
                                                <td class="text-end">$${data.totals.discounts ? data.totals.discounts.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0.00'}</td>
                                            </tr>
                                            <tr>
                                                <td class="text-start"><strong>Impuestos</strong></td>
                                                <td class="text-end">$${data.totals.taxes ? data.totals.taxes.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0.00'}</td>
                                            </tr>
                                            <tr class="table-active">
                                                <td class="text-start"><strong>Total</strong></td>
                                                <td class="text-end"><strong>$${data.totals.total ? data.totals.total.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",") : '0.00'}</strong></td>
                                            </tr>`;
                    }

                    modalContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Pie de página -->
                    <div class="invoice-footer mt-4 text-center">
                        <div class="text-muted small">Este documento es una representación digital de su factura</div>
                    </div>
                </div>`;

                    Swal.fire({
                        title: `Factura #${data.numero}`,
                        html: modalContent,
                        width: '750px',  // slightly smaller width
                        customClass: {
                            container: 'swal-invoice-modal'
                        },
                        showCloseButton: true,
                        showConfirmButton: true,
                        confirmButtonText: 'Cerrar',
                        confirmButtonColor: '#3085d6',
                        footer: `<button id="download-btn-modal" class="btn btn-secondary" data-id="${data.numero}"><i class="fas fa-download"></i> Descargar PDF</button>`,
                        didOpen: () => {
                            $('#download-btn-modal').off('click').on('click', function() {
                                const number = $(this).data('id');
                                descargarFactura(number);
                            });
                        }
                    });
                },
                error: function(xhr, status, error) {
                    Swal.close();
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudieron cargar los detalles de la factura',
                        confirmButtonColor: '#3085d6'
                    });
                }
            });
        }

        function descargarFactura(number) {
            console.log("Descargando factura número:", number);

            Swal.fire({
                title: 'Generando PDF',
                text: 'Espere por favor...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/api/facturas/factura-download/${number}`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('token') // Si usas token
                }
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(errorData => {
                            throw new Error(errorData.error || 'Error al descargar el PDF');
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `factura-${number}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    Swal.close();
                })
                .catch(error => {
                    console.error("Error al descargar el PDF:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: error.message || 'No se pudo descargar el PDF. Intente nuevamente.',
                        confirmButtonColor: '#3085d6'
                    });
                });
        }

        function descargarXml(number) {
            console.log("Descargando XML para factura Número:", number);

            if (number === 'N/A' || !number) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el número de la factura',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: 'Cargando XML',
                text: 'Espere por favor...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/api/facturas/descargar-xml/${number}`, {
                method: 'GET'
            })
                .then(response => {
                    console.log("Estado HTTP:", response.status);
                    if (!response.ok) {
                        throw new Error(`Estado ${response.status}`);
                    }
                    return response.blob();
                })
                .then(blob => {
                    // Convertir el blob a texto
                    return blob.text();
                })
                .then(xmlText => {
                    Swal.close();

                    // Mostrar el XML en una ventana emergente con formato
                    Swal.fire({
                        title: `Vista Previa del XML - Factura ${number}`,
                        html: `<pre style="text-align: left; white-space: pre-wrap; word-wrap: break-word; max-height: 400px; overflow-y: auto;">${xmlText}</pre>`,
                        width: '800px', // Ancho personalizado para mejor legibilidad
                        showConfirmButton: true,
                        confirmButtonText: 'Cerrar',
                        confirmButtonColor: '#3085d6',
                        showCancelButton: true,
                        cancelButtonText: 'Descargar',
                        cancelButtonColor: '#28a745',
                        didOpen: () => {
                            // Opcional: Si quieres resaltar el XML con una librería como Prism.js, aquí podrías integrarla
                        }
                    }).then((result) => {
                        // Si el usuario elige "Descargar", ejecutamos la lógica de descarga
                        if (result.dismiss === Swal.DismissReason.cancel) {
                            const blob = new Blob([xmlText], { type: 'application/xml' });
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = `factura-${number}.xml`;
                            document.body.appendChild(a);
                            a.click();
                            setTimeout(() => {
                                window.URL.revokeObjectURL(url);
                                document.body.removeChild(a);
                            }, 100);
                        }
                    });
                })
                .catch(error => {
                    Swal.close();
                    console.error("Error en la solicitud:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar el XML: ' + error.message,
                        confirmButtonColor: '#3085d6'
                    });
                });
        }

        function eliminarFactura(referenceCode) {
            console.log("Eliminando factura Number:", referenceCode);

            if (referenceCode === 'N/A' || !referenceCode) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el referenceCode de la factura',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: '¿Está seguro?',
                text: "Esta acción eliminará la factura permanentemente",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Eliminando',
                        text: 'Espere por favor...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        url: `/api/facturas/eliminar/${referenceCode}`,
                        method: 'DELETE',
                        success: function(response) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Éxito',
                                text: 'Factura eliminada correctamente',
                                confirmButtonColor: '#28a745'
                            }).then(() => {
                                loadFacturas();
                            });
                        },
                        error: function(xhr) {
                            Swal.close();
                            let errorMessage = xhr.responseJSON?.error || `Error ${xhr.status}: ${xhr.statusText}`;
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: errorMessage,
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    });
                }
            });
        }

        function validateFactura(number) {
            console.log("Validando factura Número:", number);

            if (number === 'N/A' || !number) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se encontró el número de la factura',
                    confirmButtonColor: '#3085d6'
                });
                return;
            }

            Swal.fire({
                title: '¿Está seguro?',
                text: "Va a validar esta factura en Factus",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#28a745',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, validar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'Validando',
                        text: 'Espere por favor...',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    $.ajax({
                        url: `/api/facturas/validar-y-descargar/${number}`,
                        method: 'GET',
                        xhrFields: {
                            responseType: 'blob'
                        },
                        success: function(data, status, xhr) {
                            Swal.close();

                            const contentType = xhr.getResponseHeader('Content-Type');
                            if (contentType.includes('application/pdf')) {
                                // Crear una URL temporal para el blob del PDF
                                const blob = new Blob([data], { type: 'application/pdf' });
                                const url = window.URL.createObjectURL(blob);

                                // Mostrar el PDF en una vista previa con Swal
                                Swal.fire({
                                    title: `Vista Previa del PDF - Factura ${number}`,
                                    html: `
                                <iframe src="${url}" width="100%" height="500px" style="border: none;"></iframe>
                            `,
                                    width: '90%',
                                    showConfirmButton: true,
                                    confirmButtonText: 'Cerrar',
                                    confirmButtonColor: '#3085d6',
                                    showCancelButton: true,
                                    cancelButtonText: 'Descargar',
                                    cancelButtonColor: '#28a745',
                                    didClose: () => {
                                        // Liberar la URL cuando se cierre la ventana
                                        window.URL.revokeObjectURL(url);
                                    }
                                }).then((result) => {
                                    // Si el usuario elige "Descargar", ejecutar la descarga
                                    if (result.dismiss === Swal.DismissReason.cancel) {
                                        const a = document.createElement('a');
                                        a.style.display = 'none';
                                        a.href = url;
                                        a.download = `factura-${number}.pdf`;
                                        document.body.appendChild(a);
                                        a.click();
                                        document.body.removeChild(a);
                                        // No liberamos la URL aquí porque ya se liberó en didClose
                                    }
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Respuesta inesperada del servidor: Content-Type no es application/pdf',
                                    confirmButtonColor: '#3085d6'
                                });
                            }
                        },
                        error: function(xhr) {
                            Swal.close();
                            let errorMessage = 'Error desconocido';
                            if (xhr.responseJSON && xhr.responseJSON.error) {
                                errorMessage = xhr.responseJSON.error;
                            } else if (xhr.status === 0) {
                                errorMessage = 'No se pudo conectar al servidor';
                            } else {
                                errorMessage = `Error ${xhr.status}: ${xhr.statusText}`;
                            }
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'No se pudo validar la factura: ' + errorMessage,
                                confirmButtonColor: '#3085d6'
                            });
                        }
                    });
                }
            });
        }
        // Función actualizada para guardar producto
        $('#guardar-producto').click(function() {
            const id = $('#producto-id').val();
            // Generar standardCodeId automáticamente (basado en el nombre del producto + timestamp)
            const currentTime = new Date().getTime();
            const nameSanitized = $('#producto-nombre').val().replace(/[^a-zA-Z0-9]/g, '').substring(0, 4).toUpperCase();

            const producto = {
                name: $('#producto-nombre').val(), // Ejemplo: "Smart Watch"
                price: parseFloat($('#producto-precio').val()), // Ejemplo: 1500000
                excluded: $('#producto-excluido').is(':checked'), // Ejemplo: false
                withholdingTaxRate: $('#producto-retencion').val() || "0", // Ejemplo: "0"
                taxRate: parseFloat($('#producto-tasa-iva').val()), // Ejemplo: 19.0
                standardCodeId: `STD-${nameSanitized}-${currentTime}`, // Ejemplo: "STD-SMAR-1698765432109"
                unitMeasureId: $('#producto-medida').val(),  // Ejemplo: "unidad 70"
            };
            // Validación básica
            if (!producto.name || producto.price <= 0 || !producto.taxRate) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre, precio y tasa de IVA son obligatorios y deben ser válidos.'
                });
                return;
            }

            if (id) {
                $.ajax({
                    url: `/api/productos/${id}`,
                    method: 'PUT',
                    data: JSON.stringify(producto),
                    contentType: 'application/json',
                    success: function() {
                        $('#productoModal').modal('hide');
                        loadProductos();
                        swal.fire({
                            toast:true,
                            position:'top-end',
                            icon:'success',
                            title:'Exito',
                            text:'Producto actualizado correctamente',
                            timer:2000,
                            showConfirmButton: false

                        });

                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al actualizar producto: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            } else {
                // Crear nuevo producto
                $.ajax({
                    url: '/api/productos',
                    method: 'POST',
                    data: JSON.stringify(producto),
                    contentType: 'application/json',
                    success: function() {
                        $('#productoModal').modal('hide');
                        loadProductos();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Producto creado correctamente',
                            timer:2000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al crear producto: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            }
        });

        // Mostrar/ocultar campos según tipo de cliente
        $('#cliente-tipo').change(function() {
            if ($(this).val() === 'Persona Jurídica') {
                $('#campos-juridica').show();
                // Si cambia a persona jurídica, cambiamos automáticamente a NIT
                $('#cliente-tipo-identificacion').val('NIT');
            } else {
                $('#campos-juridica').hide();
            }
        });

// Inicializar también al abrir el modal
        $('#clienteModal').on('show.bs.modal', function() {
            if ($('#cliente-tipo').val() === 'Persona Jurídica') {
                $('#campos-juridica').show();
            } else {
                $('#campos-juridica').hide();
            }
        });

        $('#guardar-cliente').click(function() {
            const id = $('#cliente-id').val();
            const tipoCliente = $('#cliente-tipo').val();
            const tipoIdentificacion = $('#cliente-tipo-identificacion').val();
            const identificacion = $('#cliente-identificacion').val();

            // Generar legalOrganizationId automáticamente
            let legalOrganizationId;
            if (tipoCliente === 'Persona Jurídica') {
                const companyName = $('#cliente-company').val() || $('#cliente-nombre').val();
                const companyPrefix = companyName.substring(0, 3).toUpperCase();
                legalOrganizationId = `ORG-${companyPrefix}-${new Date().getTime().toString().substring(5)}`;
            } else {
                const namePrefix = $('#cliente-nombre').val().substring(0, 3).toUpperCase();
                legalOrganizationId = `NAT-${namePrefix}-${new Date().getTime().toString().substring(5)}`;
            }

            // Generar tributeId automáticamente
            const tributePrefix = tipoIdentificacion === 'NIT' ? 'TRIB-NIT' : 'TRIB-CC';
            const tributeId = `${tributePrefix}-${identificacion.replace(/[^0-9]/g, '').substring(0, 6)}-${Math.floor(Math.random() * 1000)}`;

            // Crear objeto cliente con todos los campos
            const cliente = {
                nombre: $('#cliente-nombre').val(),
                tipoCliente: tipoCliente,
                tipoIdentificacion: tipoIdentificacion,
                identificacion: identificacion,
                telefono: $('#cliente-telefono').val(),
                correo: $('#cliente-correo').val(),
                municipio: $('#cliente-municipio').val(), // Municipality name
                municipioId: parseInt($('#cliente-municipio-id').val()) || null, // Municipality ID
                direccion: $('#cliente-direccion').val(),
                aplicaIVA: $('#cliente-aplica-iva').val(),
                legalOrganizationId: id ? $('#cliente-legalOrganizationId').val() : legalOrganizationId,
                tributeId: id ? $('#cliente-tributeId').val() : tributeId
            };

            // Validación básica
            if (!cliente.nombre || !cliente.identificacion || !cliente.tipoCliente || !cliente.municipioId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'El nombre, identificación, tipo de cliente y municipio son obligatorios.'
                });
                return;
            }

            // Agregar campos específicos para persona jurídica si aplica
            if (tipoCliente === 'Persona Jurídica') {
                cliente.company = $('#cliente-company').val();
                cliente.tradeName = $('#cliente-tradeName').val();
                cliente.verificationDigit = $('#cliente-verificationDigit').val();
                cliente.idOrg = $('#cliente-idOrg').val();
            }

            if (id) {
                // Actualizar cliente
                $.ajax({
                    url: `/api/clientes/${id}`,
                    method: 'PUT',
                    data: JSON.stringify(cliente),
                    contentType: 'application/json',
                    success: function() {
                        $('#clienteModal').modal('hide');
                        loadClientes();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Cliente actualizado correctamente',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al actualizar cliente: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            } else {
                // Crear nuevo cliente
                $.ajax({
                    url: '/api/clientes',
                    method: 'POST',
                    data: JSON.stringify(cliente),
                    contentType: 'application/json',
                    success: function() {
                        $('#clienteModal').modal('hide');
                        loadClientes();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Cliente creado correctamente',
                            timer: 2000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Error al crear cliente: ' + (xhr.responseJSON?.message || 'Desconocido')
                        });
                    }
                });
            }
        });


        function editProducto(id) {
            console.log("Fetching product data for ID:", id);

            $.ajax({
                url: `/api/productos/${id}`,
                method: 'GET',
                success: function(producto) {
                    $('#producto-id').val(producto.id);
                    $('#producto-nombre').val(producto.name);
                    $('#producto-precio').val(producto.price);
                    $('#producto-excluido').prop('checked', producto.excluded);
                    $('#producto-retencion').val(producto.withholdingTaxRate);
                    $('#producto-tasa-iva').val(producto.taxRate);

                    // Almacenar los valores existentes para los campos automáticos
                    $('#producto-standardCodeId').val(producto.standardCodeId);
                    $('#producto-unitMeasureId').val(producto.unitMeasureId);

                    $('#productoModalLabel').text('Editar Producto');
                    // Now show the modal
                    $('#productoModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error("Error loading product data:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);

                    let errorMsg = 'Error al cargar el producto';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMsg += ': ' + xhr.statusText;
                    }

                    alert(errorMsg);
                }
            });
        }

        // Función para editar cliente actualizada
        function editCliente(id) {
            console.log("Fetching client data for ID:", id);

            $.ajax({
                url: `/api/clientes/${id}`,
                method: 'GET',
                success: function(cliente) {
                    console.log("Client data received:", cliente);
                    console.log("aplicaIva value:", cliente.aplicaIva, "type:", typeof cliente.aplicaIva);

                    // First clear the form to remove any previous data
                    $('#cliente-form').trigger('reset');

                    // Set the modal title and client ID
                    $('#clienteModalLabel').text('Editar Cliente');
                    $('#cliente-id').val(cliente.id);

                    // Fill in the form fields with client data
                    $('#cliente-tipo').val(cliente.tipoCliente);
                    $('#cliente-tipo-identificacion').val(cliente.tipoIdentificacion);
                    $('#cliente-identificacion').val(cliente.identificacion);
                    $('#cliente-nombre').val(cliente.nombre);
                    $('#cliente-telefono').val(cliente.telefono);
                    $('#cliente-correo').val(cliente.correo);
                    $('#cliente-municipio').val(cliente.municipio);
                    $('#cliente-direccion').val(cliente.direccion);
                    $('#cliente-aplica-iva').val(cliente.aplicaIVA);

                    // Campos automáticos
                    $('#cliente-legalOrganizationId').val(cliente.legalOrganizationId);
                    $('#cliente-tributeId').val(cliente.tributeId);

                    // Campos específicos de persona jurídica
                    if (cliente.tipoCliente === 'Persona Jurídica') {
                        $('#cliente-company').val(cliente.company || '');
                        $('#cliente-tradeName').val(cliente.tradeName || '');
                        $('#cliente-verificationDigit').val(cliente.verificationDigit || '');
                        $('#cliente-idOrg').val(cliente.idOrg || '');
                        $('#campos-juridica').show();
                    } else {
                        $('#campos-juridica').hide();
                    }

                    // Now show the modal
                    $('#clienteModal').modal('show');
                },
                error: function(xhr, status, error) {
                    console.error("Error loading client data:", error);
                    console.error("Status:", status);
                    console.error("Response:", xhr.responseText);

                    let errorMsg = 'Error al cargar el cliente';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMsg += ': ' + xhr.statusText;
                    }

                    alert(errorMsg);
                }
            });
        }




        // Manejo de facturas
        var itemCount = 0;
        var facturaItems = [];
        // Variable global para almacenar la lista de clientes
        let clientesList = [];

        // Cargar clientes para el modal de factura
        function loadClientesFactura(callback) {
            $.ajax({
                url: '/api/clientes',
                method: 'GET',
                success: function(clientes) {
                    // Guardar la lista de clientes
                    clientesList = clientes;

                    // Configurar el select con Select2
                    const select = $('#factura-cliente');
                    select.empty();
                    select.append('<option value="">Buscar cliente por nombre o identificación...</option>');

                    clientes.forEach(function(cliente) {
                        select.append(
                            `<option value="${cliente.id}" data-identificacion="${cliente.identificacion}">
                            ${cliente.nombre} (${cliente.identificacion})
                        </option>`
                        );
                    });

                    // Inicializar Select2
                    select.select2({
                        placeholder: "Buscar cliente por nombre o identificación...",
                        allowClear: true,
                        width: '100%',
                        minimumInputLength: 0, // Permite buscar desde el primer carácter
                        dropdownParent: $('#facturaModal'), // Evita problemas con el modal
                        templateResult: formatCliente, // Formato para los resultados
                        templateSelection: formatClienteSelection, // Formato para la selección
                        matcher: customMatcher // Lógica de búsqueda personalizada
                    });

                    // Ejecutar callback si existe
                    if (typeof callback === 'function') {
                        callback();
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error cargando clientes:", error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudo cargar la lista de clientes'
                    });
                    if (typeof callback === 'function') {
                        callback();
                    }
                }
            });
        }

        // Formato para los resultados de búsqueda
        function formatCliente(cliente) {
            if (!cliente.id) return cliente.text; // Para el placeholder
            return $(
                `<span>${cliente.text}</span>`
            );
        }

        // Formato para el cliente seleccionado
        function formatClienteSelection(cliente) {
            if (!cliente.id) return cliente.text; // Para el placeholder
            return cliente.text;
        }

        // Lógica de búsqueda personalizada (por nombre o identificación)
        function customMatcher(params, data) {
            // Si no hay término de búsqueda, mostrar todos los resultados
            if ($.trim(params.term) === '') {
                return data;
            }

            const term = params.term.toLowerCase();
            const nombre = data.text.toLowerCase();
            const identificacion = $(data.element).data('identificacion')?.toString().toLowerCase() || '';

            // Filtrar por nombre o identificación
            if (nombre.indexOf(term) > -1 || identificacion.indexOf(term) > -1) {
                return data;
            }

            return null;
        }

        // Función para manejar la selección de cliente
        function onClienteSelected() {
            const clienteId = $('#factura-cliente').val();

            if (!clienteId) {
                clearClienteInfo();
                $('#factura-municipio-id').val('');
                return;
            }

            const clienteSeleccionado = clientesList.find(c => c.id == clienteId);

            if (clienteSeleccionado) {
                // Rellenar campos de información del cliente
                $('#cliente-nombres').text(clienteSeleccionado.nombre || '-');
                $('#cliente-tipos').text(clienteSeleccionado.tipoCliente || '-');
                $('#cliente-correos').text(clienteSeleccionado.correo || '-');
                $('#cliente-telefonos').text(clienteSeleccionado.telefono || '-');
                $('#cliente-direcciones').text(clienteSeleccionado.direccion || '-');
                $('#cliente-municipios').text(clienteSeleccionado.municipio || '-');

                // Rellenar campos automáticos de la factura
                $('#factura-identification').val(clienteSeleccionado.identificacion || '');
                $('#factura-api-client-name').val(clienteSeleccionado.nombre || '');
                $('#factura-graphic-representation').val('PDF');
                $('#factura-municipio-id').val(clienteSeleccionado.municipioId || '');

                // Generar campos automáticos
                generateAutoFields();
            } else {
                console.error('Cliente no encontrado en la lista');
                clearClienteInfo();
                $('#factura-municipio-id').val('');
            }
        }

        // Limpiar información del cliente
        function clearClienteInfo() {
            $('#cliente-nombres, #cliente-tipos, #cliente-correos, #cliente-telefonos, #cliente-direcciones, #cliente-municipios').text('-');
            $('#factura-identification, #factura-api-client-name, #factura-graphic-representation').val('');
        }

        // Generar campos automáticos
        function generateAutoFields() {
            const facturaNumero = "FAC" + Math.random().toString(36).substring(2, 10).toUpperCase();
            $('#factura-numero').text(facturaNumero);

            const referenceCode = "REF-" + Date.now() + "-" + Math.floor(Math.random() * 1000);
            $('#factura-reference-code').val(referenceCode);
            $('#factura-reference-code-display').text(referenceCode);

            const numberingRangeId = Math.floor(Math.random() * 10000) + 1;
            $('#factura-numbering-range-id').val(numberingRangeId);

            const formaPago = $('#factura-forma-pago').val();
            const today = new Date();
            let dueDate = today;
            if (formaPago === 'Crédito') {
                dueDate = new Date(today.setDate(today.getDate() + 30));
            }
            const yyyy = dueDate.getFullYear();
            let mm = dueDate.getMonth() + 1;
            let dd = dueDate.getDate();
            if (dd < 10) dd = '0' + dd;
            if (mm < 10) mm = '0' + mm;
            $('#factura-due-date').val(`${yyyy}-${mm}-${dd}`);
        }

        // Inicializar el modal de factura
        $('#facturaModal').on('show.bs.modal', function(e) {
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-factura')) {
                $('#facturaModalLabel').text('Nueva Factura');
                $('#factura-form').trigger('reset');
                $('#factura-id').val('');
                $('#factura-items').empty();
                facturaItems = [];
                itemCount = 0;
                updateFacturaTotals();
                clearClienteInfo();

                // Cargar clientes y configurar Select2
                loadClientesFactura(function() {
                    $('#factura-cliente').off('change').on('change', function() {
                        onClienteSelected();
                    });
                });

                const today = new Date();
                const yyyy = today.getFullYear();
                let mm = today.getMonth() + 1;
                let dd = today.getDate();
                if (dd < 10) dd = '0' + dd;
                if (mm < 10) mm = '0' + mm;
                $('#factura-fecha').val(yyyy + '-' + mm + '-' + dd);
            }
        });

        function loadProductos(page = 1, itemsPerPage = 9) {
            $.ajax({
                url: '/api/productos',
                method: 'GET',
                success: function(data) {
                    // Ordenar productos por ID descendente (los más nuevos primero)
                    data.sort((a, b) => b.id - a.id);
                    console.log('Productos cargados:', data); // Verifica los datos crudos
                    const tbody = $('#productos-table-body');
                    tbody.empty();

                    // Filtrado por búsqueda
                    const searchTerm = $('#buscar-productos').val().toLowerCase();
                    const filteredData = data.filter(producto =>
                        producto.id.toString().includes(searchTerm) ||
                        producto.name.toLowerCase().includes(searchTerm)
                    );
                    console.log('Productos filtrados:', filteredData);

                    // Paginación
                    const totalItems = filteredData.length;
                    const totalPages = Math.ceil(totalItems / itemsPerPage);
                    console.log('Total páginas:', totalPages);

                    const startIndex = (page - 1) * itemsPerPage;
                    const endIndex = startIndex + itemsPerPage;
                    const paginatedData = filteredData.slice(startIndex, endIndex);
                    console.log('Datos paginados (página ' + page + '):', paginatedData);

                    // Llenar tabla
                    paginatedData.forEach(function(producto) {
                        tbody.append(`
        <tr>
            <td>${producto.id}</td>
            <td>${producto.name}</td>
            <td>$${parseFloat(producto.price).toFixed(2)}</td>
            <td>${producto.unitMeasureId || 'N/A'}</td>
            <td>${producto.taxRate ? producto.taxRate + '%' : '0%'}</td>
            <td>${producto.standardCodeId || 'Auto'}</td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-sm btn-primary edit-producto" data-id="${producto.id}" data-bs-toggle="tooltip" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger delete-producto" data-id="${producto.id}" data-bs-toggle="tooltip" title="Eliminar">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `);
                    });
                    // Mostrar mensaje si no hay datos
                    if (paginatedData.length === 0) {
                        tbody.append(`
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h4>No hay productos</h4>
                                <p>No se encontraron productos que coincidan con la búsqueda.</p>
                            </div>
                        </td>
                    </tr>
                `);
                    }

                    // Renderizar paginación
                    renderPagination(totalPages, page, 'productos');

                    $('.edit-producto').click(function(e) {
                        e.preventDefault();
                        const id = $(this).data('id');
                        editProducto(id);
                    });

                    $('.delete-producto').click(function(e) {
                        e.preventDefault();
                        const id = $(this).data('id');
                        openDeleteModal('producto', id);
                    });
                },
                error: function(xhr) {
                    console.error('Error al cargar productos:', xhr);
                    $('#productos-table-body').html(`
                <tr>
                    <td colspan="7" class="text-center text-danger">
                        Error al cargar productos
                    </td>
                </tr>
            `);
                }
            });
        }
// Variables globales para productos y paginación
        let productosList = [];
        let currentPage = 1;
        const itemsPerPage = 5;

// Formato de moneda
        function formatCurrency(value) {
            return '$' + parseFloat(value).toFixed(2);
        }

// Cargar productos con paginación y filtros
        function loadProductosSeleccion(page = 1) {
            $.ajax({
                url: '/api/productos',
                method: 'GET',
                success: function(data) {
                    productosList = data.sort((a, b) => b.id - a.id); // Ordenar por ID descendente
                    currentPage = page;
                    applyFiltersAndRender(page);
                },
                error: function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: 'No se pudieron cargar los productos'
                    });
                }
            });
        }

// Aplicar filtros y renderizar productos
        function applyFiltersAndRender(page) {
            const searchTerm = $('#buscar-producto').val().toLowerCase();

            // Filtrar productos por nombre o código
            let filteredProductos = productosList.filter(p =>
                p.id.toString().includes(searchTerm) ||
                p.name.toLowerCase().includes(searchTerm)
            );

            // Calcular paginación
            const totalItems = filteredProductos.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (page - 1) * itemsPerPage;
            const paginatedProductos = filteredProductos.slice(startIndex, startIndex + itemsPerPage);

            // Renderizar tabla
            const tbody = $('#seleccionar-producto-body');
            tbody.empty();

            paginatedProductos.forEach(producto => {
                tbody.append(`
            <tr>
                <td>${producto.id}</td>
                <td>${producto.name}</td>
                <td>${formatCurrency(producto.price)}</td>
                <td>${producto.taxRate || 0}%</td>
                <td>
                    <button class="btn btn-sm btn-primary seleccionar-producto"
                            data-id="${producto.id}"
                            data-name="${producto.name}"
                            data-price="${producto.price}"
                            data-tax-rate="${producto.taxRate || 0}">
                        <i class="fas fa-check"></i>
                    </button>
                </td>
            </tr>
        `);
            });

            // Mostrar mensaje si no hay productos
            if (paginatedProductos.length === 0) {
                tbody.append(`
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <i class="fas fa-box-open"></i>
                    <p>No se encontraron productos</p>
                </td>
            </tr>
        `);
            }

            // Actualizar contador
            $('#productos-total').text(`${totalItems} productos`);

            // Renderizar paginación
            renderPaginations(totalPages, page);
        }

// Renderizar paginación
        function renderPaginations(totalPages, currentPage) {
            const pagination = $('#producto-pagination');
            pagination.empty();

            if (totalPages <= 1) return;

            // Botón anterior
            pagination.append(`
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}"><i class="fas fa-chevron-left"></i></a>
        </li>
    `);

            // Páginas
            for (let i = 1; i <= totalPages; i++) {
                pagination.append(`
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${i}">${i}</a>
            </li>
        `);
            }

            // Botón siguiente
            pagination.append(`
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}"><i class="fas fa-chevron-right"></i></a>
        </li>
    `);

            // Evento de cambio de página
            pagination.find('.page-link').click(function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page && !$(this).parent().hasClass('disabled')) {
                    currentPage = page;
                    applyFiltersAndRender(page);
                }
            });
        }

// Evento de búsqueda
        $('#buscar-producto').on('input', function() {
            currentPage = 1;
            applyFiltersAndRender(currentPage);
        });

// Abrir modal de productos
        $('#agregar-item').click(function() {
            currentPage = 1;
            loadProductosSeleccion(currentPage);
            $('#seleccionarProductoModal').modal('show');
        });

// Seleccionar producto
        $(document).on('click', '.seleccionar-producto', function() {
            const id = $(this).data('id');
            const name = $(this).data('name');
            const price = $(this).data('price');
            const taxRate = $(this).data('tax-rate');
            addItemToFactura(id, name, price, taxRate);
            $('#seleccionarProductoModal').modal('hide');
        });

        function addItemToFactura(id, name, price, taxRate) {
            const item = {
                id: id,
                name: name,
                price: parseFloat(price),
                quantity: 1,
                taxRate: parseFloat(taxRate),
                discount: 0
            };

            itemCount++;
            facturaItems.push(item);

            const subtotal = item.price * item.quantity;
            const discount = subtotal * (item.discount / 100);
            const taxValue = (subtotal - discount) * (item.taxRate / 100);
            const total = subtotal - discount + taxValue;

            $('#factura-items').append(`
        <tr id="item-${itemCount}">
            <td>${item.name}</td>
            <td>
                <input type="number" class="form-control item-quantity" data-index="${facturaItems.length - 1}" value="${item.quantity}" min="1">
            </td>
            <td>$${item.price.toFixed(2)}</td>
            <td>
                <input type="number" class="form-control item-discount" data-index="${facturaItems.length - 1}" value="${item.discount}" min="0" max="100">
            </td>
            <td class="item-subtotal">$${subtotal.toFixed(2)}</td>
            <td class="item-tax">$${taxValue.toFixed(2)}</td>
            <td class="item-total">$${total.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-dangers remove-item" data-index="${facturaItems.length - 1}">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `);
            updateFacturaTotals();

            // Agregar eventos a los controles
            $('.item-quantity, .item-discount').on('change', function() {
                const index = $(this).data('index');
                updateItemCalculations(index);
            });

            $('.remove-item').click(function() {
                const index = $(this).data('index');
                removeFacturaItem(index);
            });
        }

        function updateItemCalculations(index) {
            const item = facturaItems[index];
            item.quantity = parseFloat($('.item-quantity[data-index="' + index + '"]').val()) || 1;
            item.discount = parseFloat($('.item-discount[data-index="' + index + '"]').val()) || 0;

            const subtotal = item.price * item.quantity;
            const discount = subtotal * (item.discount / 100);
            const taxValue = (subtotal - discount) * (item.taxRate / 100);
            const total = subtotal - discount + taxValue;

            const row = $('#factura-items tr').eq(index);
            row.find('.item-subtotal').text('$' + subtotal.toFixed(2));
            row.find('.item-tax').text('$' + taxValue.toFixed(2));
            row.find('.item-total').text('$' + total.toFixed(2));

            updateFacturaTotals();
        }

        function removeFacturaItem(index) {
            facturaItems.splice(index, 1);
            $('#factura-items tr').eq(index).remove();

            // Actualizar los índices de los elementos restantes
            $('#factura-items tr').each(function(i) {
                $(this).find('.item-quantity').data('index', i);
                $(this).find('.item-discount').data('index', i);
                $(this).find('.remove-item').data('index', i);
            });

            updateFacturaTotals();
        }

        function updateFacturaTotals() {
            let subtotal = 0;
            let totalIva = 0;
            let totalDescuento = 0;
            let total = 0;

            facturaItems.forEach(function(item) {
                const itemSubtotal = item.price * item.quantity;
                const itemDiscount = itemSubtotal * (item.discount / 100);
                const itemTax = (itemSubtotal - itemDiscount) * (item.taxRate / 100);

                subtotal += itemSubtotal;
                totalDescuento += itemDiscount;
                totalIva += itemTax;
                total += itemSubtotal - itemDiscount + itemTax;
            });

            $('#factura-subtotal').text('$' + subtotal.toFixed(2));
            $('#factura-iva-total').text('$' + totalIva.toFixed(2));
            $('#factura-descuento-total').text('$' + totalDescuento.toFixed(2));
            $('#factura-total').text('$' + total.toFixed(2));
            $('#factura-lines-count').text(facturaItems.length); // Actualizar número de líneas
        }

        // Modificación de la función guardar factura
        $('#guardar-factura').click(function() {
            if (facturaItems.length === 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Debe agregar al menos un producto a la factura'
                });
                return;
            }

            const clienteId = $('#factura-cliente').val();
            if (!clienteId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Debe seleccionar un cliente'
                });
                return;
            }

            const id = $('#factura-id').val();
            const clienteSeleccionado = clientesList.find(c => c.id == clienteId);

            // Calcular tributos
            const tributes = [];
            const totalIva = parseFloat($('#factura-iva-total').text().replace('$', ''));
            if (totalIva > 0) {
                tributes.push({
                    tribute_id: "01", // IVA
                    rate: 19.0,
                    amount: totalIva
                });
            }
            // Ejemplo: Agregar INC si aplica (puedes definir una lógica para productos con INC)
            // Aquí asumimos que no hay INC a menos que lo especifiques
            // const incAmount = 1000.0; // Ejemplo
            // tributes.push({ tribute_id: "03", rate: 8.0, amount: incAmount });

            const factura = {
                cliente: {
                    id: clienteSeleccionado.id,
                    nombre: clienteSeleccionado.nombre,
                    correo: clienteSeleccionado.correo,
                    direccion: clienteSeleccionado.direccion,
                    telefono: clienteSeleccionado.telefono || '', // Añadir teléfono
                    tipoCliente: clienteSeleccionado.tipoCliente,
                    identificacion: clienteSeleccionado.identificacion,
                    municipio: clienteSeleccionado.municipio,
                    municipioId: parseInt(clienteSeleccionado.municipioId) || null // Asegurar que se envíe el valor correcto
                },
                documentName: $('#factura-document-name').val(),
                graphicRepresentationName: "PDF",
                formaPago: $('#factura-forma-pago').val(),
                metodo: $('#factura-metodo-pago').val(),
                createdAt: new Date().toISOString(),
                document: $('#factura-document').val(),
                numberingRangeId: parseInt($('#factura-numbering-range-id').val()) || 128,
                referenceCode: $('#factura-reference-code').val(),
                observation: $('#factura-observation').val(),
                subtotal: parseFloat($('#factura-subtotal').text().replace('$', '')),
                totalIva: parseFloat($('#factura-iva-total').text().replace('$', '')),
                totalDescuento: parseFloat($('#factura-descuento-total').text().replace('$', '')),
                total: parseFloat($('#factura-total').text().replace('$', '')),
                municipio: parseInt($('#factura-municipio-id').val()) || null, // Usar el valor del campo oculto
                fechaVencimiento: $('#factura-due-date').val() || "2025-05-01", // Forzamos para probar
                linesCount: facturaItems.length, // Enviar número de líneas
                tributes: tributes, // Enviar tributos
                items: facturaItems.map(item => ({
                    producto: {
                        id: item.id,
                        name: item.name,
                        price: item.price,
                        taxRate: item.taxRate,
                        unitMeasureId: "70", // Valor por defecto
                        standardCodeId: "1", // Valor por defecto
                        excluded: false // Ajusta según lógica
                    },
                    cantidad: item.quantity,
                    precio: item.price,
                    porcentajeDescuento: item.discount,
                    subtotal: item.price * item.quantity,
                    iva: (item.price * item.quantity * (item.taxRate / 100)),
                    total: (item.price * item.quantity) - (item.price * item.quantity * (item.discount / 100)) + (item.price * item.quantity * (item.taxRate / 100))
                }))
            };

            if (id) {
                // Actualizar factura
                $.ajax({
                    url: `/api/facturas/${id}`,
                    method: 'PUT',
                    data: JSON.stringify(factura),
                    contentType: 'application/json',
                    success: function(response) {
                        $('#facturaModal').modal('hide');
                        loadFacturas();
                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: 'Documento con el código de referencia actualizado con éxito',
                            timer: 3000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        let errorMsg = 'Error al actualizar factura';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg += ': ' + xhr.responseJSON.message;
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMsg,
                            confirmButtonColor: '#d33'
                        });
                    }
                });
            } else {
                $.ajax({
                    url: '/api/facturas/crear',
                    method: 'POST',
                    data: JSON.stringify(factura),
                    contentType: 'application/json',
                    success: function(response) {
                        $('#facturaModal').modal('hide');
                        loadFacturas();

                        // Obtener el reference_code de la respuesta o del objeto factura
                        let referenceCode = response.referenceCode || factura.referenceCode || 'desconocido';

                        Swal.fire({
                            toast: true,
                            position: 'top-end',
                            icon: 'success',
                            title: 'Éxito',
                            text: `Documento con el código de referencia ${referenceCode} registrado y validado con éxito`,
                            timer: 5000,
                            showConfirmButton: false
                        });
                    },
                    error: function(xhr) {
                        let errorMsg = 'Error al crear la factura';
                        if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg += ': ' + xhr.responseJSON.error;
                        } else {
                            errorMsg += ': ' + (xhr.statusText || 'Error desconocido');
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: errorMsg,
                            confirmButtonColor: '#d33'
                        });
                    }
                });
            }
        });

        function editFactura(id) {
            console.log("Fetching invoice data for ID:", id);

            $.ajax({
                url: `/api/facturas/${id}`,
                method: 'GET',
                success: function(factura) {
                    console.log("Invoice data received:", factura);

                    $('#facturaModalLabel').text('Editar Factura');
                    $('#factura-id').val(factura.id);

                    $.ajax({
                        url: '/api/clientes',
                        method: 'GET',
                        success: function(clientes) {
                            const select = $('#factura-cliente');
                            select.empty();
                            select.append('<option value="">Seleccionar cliente...</option>');

                            clientes.forEach(function(cliente) {
                                select.append(`<option value="${cliente.id}">${cliente.nombre}</option>`);
                            });

                            const clientId = factura.clienteId || (factura.cliente ? factura.cliente.id : null);

                            if (clientId) {
                                console.log("Setting client ID:", clientId);
                                $('#factura-cliente').val(clientId);

                                if ($('#factura-cliente').val() != clientId && factura.cliente) {
                                    $('#factura-cliente option').each(function() {
                                        if ($(this).text().includes(factura.cliente.nombre)) {
                                            $(this).prop('selected', true);
                                            return false;
                                        }
                                    });
                                }
                            }

                            $('#factura-cliente').trigger('change');

                            if (factura.cliente) {
                                $('#cliente-nombres').text(factura.cliente.nombre || '-');
                                $('#cliente-tipos').text(factura.cliente.tipoCliente || '-');
                                $('#cliente-correos').text(factura.cliente.correo || '-');
                                $('#cliente-telefonos').text(factura.cliente.telefono || '-');
                                $('#cliente-direcciones').text(factura.cliente.direccion || '-');
                                $('#cliente-municipios').text(factura.cliente.municipio || '-');
                                $('#factura-municipio-id').val(factura.cliente.municipioId || ''); // Set municipioId
                            }

                            $('#factura-forma-pago').val(factura.formaPago);
                            $('#factura-metodo-pago').val(factura.metodo);

                            if (factura.fecha) {
                                const fechaStr = factura.fecha.split('T')[0];
                                $('#factura-fecha').val(fechaStr);
                            }

                            $('#factura-status').text(factura.status || 'PENDIENTE');
                            $('#factura-numero').text(factura.number || 'N/A');
                            $('#factura-reference-code').val(factura.referenceCode || '');
                            $('#factura-reference-code-display').text(factura.referenceCode || '-');
                            $('#factura-numbering-range-id').val(factura.numberingRangeId || '');
                            $('#factura-observation').val(factura.observation || '');
                            $('#factura-document').val(factura.document || '');
                            $('#factura-document-display').text(factura.document || 'Factura electrónica de venta');

                            $('#factura-identification').val(factura.identification || '');
                            $('#factura-api-client-name').val(factura.apiClientName || '');
                            $('#factura-graphic-representation').val(factura.graphicRepresentationName || '');
                            $('#factura-document-name').val(factura.documentName || 'Factus');

                            $('#factura-subtotal').text(factura.subtotal ? formatCurrency(factura.subtotal) : '$0.00');
                            $('#factura-iva-total').text(factura.totalIva ? formatCurrency(factura.totalIva) : '$0.00');
                            $('#factura-descuento-total').text(factura.totalDescuento ? formatCurrency(factura.totalDescuento) : '$0.00');
                            $('#factura-total').text(factura.total ? formatCurrency(factura.total) : '$0.00');

                            $('#factura-items').empty();
                            facturaItems = [];
                            itemCount = 0;

                            console.log("Loading invoice items:", factura.items);

                            if (factura.items && factura.items.length > 0) {
                                factura.items.forEach(function(item) {
                                    if (item.producto) {
                                        addItemToFactura(
                                            item.producto.id,
                                            item.producto.name,
                                            item.precio,
                                            item.producto.taxRate || 0
                                        );

                                        const index = facturaItems.length - 1;
                                        facturaItems[index].quantity = item.cantidad;
                                        facturaItems[index].discount = item.porcentajeDescuento || 0;

                                        $('.item-quantity[data-index="' + index + '"]').val(item.cantidad);
                                        $('.item-discount[data-index="' + index + '"]').val(item.porcentajeDescuento || 0);

                                        updateItemCalculations(index);
                                    } else {
                                        console.error("Item missing product data:", item);
                                    }
                                });
                            }

                            $('#facturaModal').modal('show');
                        },
                        error: function(xhr) {
                            console.error("Error loading clientes:", xhr);
                            alert('Error al cargar la lista de clientes');
                        }
                    });
                },
                error: function(xhr) {
                    console.error("Error loading invoice data:", xhr);
                    let errorMsg = 'Error al cargar la factura';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg += ': ' + xhr.responseJSON.message;
                    } else if (xhr.statusText) {
                        errorMsg += ': ' + xhr.statusText;
                    }
                    alert(errorMsg);
                }
            });
        }


        // Eliminar elementos
        function openDeleteModal(type, id) {
            $('#delete-type').val(type);
            $('#delete-id').val(id);
            $('#confirmDeleteModal').modal('show');
        }

        $('#confirmar-eliminacion').click(function() {
            const type = $('#delete-type').val();
            const id = $('#delete-id').val();

            let url = '';
            let refreshFunction = null;

            switch(type) {
                case 'producto':
                    url = `/api/productos/${id}`;
                    refreshFunction = loadProductos;
                    break;
                case 'cliente':
                    url = `/api/clientes/${id}`;
                    refreshFunction = loadClientes;
                    break;
                case 'factura':
                    url = `/api/facturas/${id}`;
                    refreshFunction = loadFacturas;
                    break;
            }

            $.ajax({
                url: url,
                method: 'DELETE',
                success: function() {
                    $('#confirmDeleteModal').modal('hide');
                    refreshFunction();
                    Swal.fire({
                        toast:true,
                        position:'top-end',
                        icon: 'success',
                        title: 'Éxito',
                        text: `${type.charAt(0).toUpperCase() + type.slice(1)} eliminado correctamente`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                },
                error: function(error) {
                    alert(`Error al eliminar ${type}: ${error.responseJSON.message}`);
                }
            });
        });

        // Inicialización de modales
        $('#productoModal').on('show.bs.modal', function(e) {
            // Only reset the form if it's a new product (not an edit operation)
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-producto')) {
                $('#productoModalLabel').text('Nuevo Producto');
                $('#producto-form').trigger('reset');
                $('#producto-id').val('');
            }
        });

        // Update modal initialization
        $('#clienteModal').on('show.bs.modal', function(e) {
            // Only reset the form if it's a new client (not an edit operation)
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-cliente')) {
                $('#clienteModalLabel').text('Nuevo Cliente');
                $('#cliente-form').trigger('reset');
                $('#cliente-id').val('');
            }
        });

// Modificar la función que muestra el modal
        $('#facturaModal').on('show.bs.modal', function (e) {
            // Limpiar el formulario si es una nueva factura
            if (e.relatedTarget && !$(e.relatedTarget).hasClass('edit-factura')) {
                $('#facturaModalLabel').text('Nueva Factura');
                $('#factura-form').trigger('reset');
                $('#factura-id').val('');
                $('#factura-items').empty();
                facturaItems = [];
                itemCount = 0;
                updateFacturaTotals();

                // Limpiar información del cliente
                clearClienteInfo();

                // Cargar clientes
                loadClientesFactura(function() {
                    // Configurar el evento de selección del cliente
                    $('#factura-cliente').off('change').on('change', function() {
                        onClienteSelected();
                    });
                });

                // Establecer fecha actual
                const today = new Date();
                const yyyy = today.getFullYear();
                let mm = today.getMonth() + 1;
                let dd = today.getDate();

                if (dd < 10) dd = '0' + dd;
                if (mm < 10) mm = '0' + mm;

                $('#factura-fecha').val(yyyy + '-' + mm + '-' + dd);
            }
        });
        // Agregar producto a factura
        $('#agregar-item').click(function() {
            loadProductosSeleccion();
            $('#seleccionarProductoModal').modal('show');
        });

        $('#buscar-producto').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();
            let found = false;

            $('#seleccionar-producto-body tr').each(function() {
                const name = $(this).find('td:eq(1)').text().toLowerCase();
                const id = $(this).find('td:eq(0)').text().toLowerCase();

                if (name.includes(searchTerm) || id.includes(searchTerm)) {
                    $(this).show();
                    found = true;
                } else {
                    $(this).hide();
                }
            });

            // Mostrar mensaje si no hay resultados
            if (!found) {
                $('#seleccionar-producto-body').append(`
            <tr id="no-results">
                <td colspan="6" class="text-center text-muted">No se encontraron productos</td>
            </tr>
        `);
            } else {
                $('#no-results').remove();
            }
        });

        // Cargar dashboard al inicio
        loadDashboardStats();
    });
</script>